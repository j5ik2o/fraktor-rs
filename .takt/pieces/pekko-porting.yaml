name: pekko-porting
description: Pekko互換仕様をRustで実装するための開発ピース（ギャップ分析→実装→QA並列レビュー→Pekko互換レビュー→監督）
piece_config:
  provider_options:
    codex:
      network_access: true
    opencode:
      network_access: true
max_movements: 30
initial_movement: plan

personas:
  pekko-compat-reviewer: ../facets/personas/pekko-compat-reviewer.md

knowledge:
  pekko-porting: ../facets/knowledge/pekko-porting.md

policies:
  fraktor-coding: ../facets/policies/fraktor-coding.md
  pekko-compat: ../facets/policies/pekko-compat.md

instructions:
  plan-pekko-impl: ../facets/instructions/plan-pekko-impl.md
  review-pekko-compat: ../facets/instructions/review-pekko-compat.md
  coderabbit-review: ../facets/instructions/coderabbit-review.md
  ai-review: ../facets/instructions/ai-review.md
  ai-fix: ../facets/instructions/ai-fix.md
  arbitrate: ../facets/instructions/arbitrate.md

report_formats:
  pekko-compat-review: ../facets/output-contracts/pekko-compat-review.md
  coderabbit-review: ../facets/output-contracts/coderabbit-review.md

loop_monitors:
  - cycle:
      - ai_review
      - ai_fix
    threshold: 3
    judge:
      persona: supervisor
      instruction_template: |
        ai_review と ai_fix のループが {cycle_count} 回繰り返されました。

        各サイクルのレポートを確認し、このループが健全（進捗がある）か、
        非生産的（同じ問題を繰り返している）かを判断してください。

        **参照するレポート:**
        - AIレビュー結果: {report:04-ai-review.md}

        **判断基準:**
        - 各サイクルで新しい問題が発見・修正されているか
        - 同じ指摘が繰り返されていないか
        - 修正が実際に反映されているか
      rules:
        - condition: 健全（進捗あり）
          next: ai_review
        - condition: 非生産的（改善なし）
          next: ai_no_fix

  - cycle:
      - ai_fix
      - ai_no_fix
    threshold: 3
    judge:
      persona: supervisor
      instruction_template: |
        ai_fix と ai_no_fix のループが {cycle_count} 回繰り返されました。

        ai_fix が修正不要と判断し、ai_no_fix が修正必要と差し戻すサイクルが
        繰り返されています。このループが健全か判断してください。

        **判断基準:**
        - ai_fix と ai_no_fix の間で同じ指摘について意見が分かれ続けていないか
        - 新しい観点や情報が各サイクルで追加されているか
        - 合意に向かう進捗があるか
      rules:
        - condition: 健全（進捗あり）
          next: ai_fix
        - condition: 非生産的（改善なし）
          next: reviewers

  - cycle:
      - reviewers
      - qa-fix
    threshold: 3
    judge:
      persona: supervisor
      instruction_template: |
        reviewers と qa-fix のレビュー・修正サイクルが {cycle_count} 回繰り返されました。

        各サイクルのレポートを確認し、このループが健全（進捗がある）か、
        非生産的（同じ問題を繰り返している）かを判断してください。

        **参照するレポート:**
        - QAレビュー: {report:06-qa-review.md}
        - Coderabbitレビュー: {report:07-coderabbit-review.md}

        **判断基準:**
        - 各サイクルで修正対象が収束しているか
        - 同じ指摘が繰り返されていないか
        - 反映履歴から改善進捗が確認できるか
      rules:
        - condition: 健全（進捗あり）
          next: reviewers
        - condition: 非生産的（改善なし）
          next: pekko-compat-review

  - cycle:
      - pekko-compat-review
      - pekko-compat-fix
    threshold: 3
    judge:
      persona: supervisor
      instruction_template: |
        pekko-compat-review と pekko-compat-fix のレビュー・修正サイクルが {cycle_count} 回繰り返されました。

        各サイクルのレポートを確認し、このループが健全（進捗がある）か、
        非生産的（同じ問題を繰り返している）かを判断してください。

        **参照するレポート:**
        - Pekko互換性レビュー: {report:05-pekko-compat-review.md}

        **判断基準:**
        - 各サイクルで新しい問題が発見・修正されているか
        - 同じ指摘が繰り返されていないか
        - 修正が実際に反映されているか
      rules:
        - condition: 健全（進捗あり）
          next: pekko-compat-review
        - condition: 非生産的（改善なし）
          next: supervise

  - cycle:
      - supervise
      - pekko-compat-fix
    threshold: 3
    judge:
      persona: supervisor
      instruction_template: |
        supervise と pekko-compat-fix のサイクルが {cycle_count} 回繰り返されました。

        各サイクルのレポートを確認し、このループが健全（進捗がある）か、
        非生産的（同じ問題を繰り返している）かを判断してください。

        **参照するレポート:**
        - スーパーバイザー検証: {report:supervisor-validation.md}

        **判断基準:**
        - 各サイクルで修正が実際に反映され、前回の指摘が解消されているか
        - 同じテスト失敗やビルドエラーが繰り返されていないか
      rules:
        - condition: 健全（進捗あり）
          next: supervise
        - condition: 非生産的（改善なし）
          next: ABORT

movements:
  - name: plan
    edit: false
    persona: planner
    knowledge:
      - pekko-porting
      - architecture
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Bash
      - WebSearch
      - WebFetch
    instruction: plan-pekko-impl
    output_contracts:
      report:
        - name: 00-plan.md
          format: plan
    rules:
      - condition: 要件が明確で実装可能
        next: implement
      - condition: ユーザーが質問をしている（実装タスクではない）
        next: COMPLETE
      - condition: 要件が不明確、情報不足
        next: ABORT
        appendix: |
          確認事項:
          - {質問1}
          - {質問2}

  - name: implement
    edit: true
    persona: coder
    policy:
      - coding
      - testing
      - fraktor-coding
    session: refresh
    knowledge:
      - pekko-porting
      - architecture
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Edit
      - Write
      - Bash
      - WebSearch
      - WebFetch
    required_permission_mode: edit
    instruction: implement
    instruction_template: |
      **修正完了条件（必須）:**
      修正後に必ず以下を順番に実行し、全チェックがパスすることを確認してからレポートに記録すること:
      1. `./scripts/ci-check.sh dylint` （Dylint全lint）
      2. `./scripts/ci-check.sh all` （全CI）
      成功ログをcoder-decisionsレポートの「実行結果」セクションに含めること。
    output_contracts:
      report:
        - name: coder-scope.md
          format: coder-scope
        - name: coder-decisions.md
          format: coder-decisions
    rules:
      - condition: 実装完了
        next: ai_review
      - condition: 実装未着手（レポートのみ）
        next: ai_review
      - condition: 判断できない、情報不足
        next: ai_review
      - condition: ユーザー入力が必要
        next: implement
        requires_user_input: true
        interactive_only: true

  - name: ai_review
    edit: false
    persona: ai-antipattern-reviewer
    policy:
      - review
      - ai-antipattern
    allowed_tools:
      - Read
      - Glob
      - Grep
      - WebSearch
      - WebFetch
    instruction: ai-review
    output_contracts:
      report:
        - name: 04-ai-review.md
          format: ai-review
    rules:
      - condition: AI特有の問題なし
        next: reviewers
      - condition: AI特有の問題あり
        next: ai_fix

  - name: ai_fix
    edit: true
    persona: coder
    policy:
      - coding
      - testing
      - fraktor-coding
    session: refresh
    knowledge:
      - pekko-porting
      - architecture
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Edit
      - Write
      - Bash
      - WebSearch
      - WebFetch
    required_permission_mode: edit
    pass_previous_response: false
    instruction: ai-fix
    rules:
      - condition: AI問題の修正完了
        next: ai_review
      - condition: 修正不要（指摘対象ファイル/仕様の確認済み）
        next: ai_no_fix
      - condition: 判断できない、情報不足
        next: ai_no_fix

  - name: ai_no_fix
    edit: false
    persona: architecture-reviewer
    policy:
      - review
    allowed_tools:
      - Read
      - Glob
      - Grep
    instruction: arbitrate
    rules:
      - condition: ai_reviewの指摘が妥当（修正すべき）
        next: ai_fix
      - condition: ai_fixの判断が妥当（修正不要）
        next: reviewers

  - name: reviewers
    parallel:
      - name: qa-review
        edit: false
        persona: qa-reviewer
        policy:
          - review
          - qa
        allowed_tools:
          - Read
          - Glob
          - Grep
          - WebSearch
          - WebFetch
        instruction: review-qa
        instruction_template: |
          **やらないこと:**
          `cargo check` / `cargo build` / `cargo test` など、ビルドを伴うコマンドを実行しないこと。このムーブメントはビルド権限がなく `Operation not permitted` で失敗する。ビルド検証は `qa-fix` / `pekko-compat-fix` / `implement` ムーブメントの責務。
        output_contracts:
          report:
            - name: 06-qa-review.md
              format: qa-review
        rules:
          - condition: approved
          - condition: needs_fix
      - name: coderabbit-review
        edit: false
        persona: qa-reviewer
        policy:
          - review
          - qa
        knowledge:
          - pekko-porting
          - architecture
        allowed_tools:
          - Read
          - Glob
          - Grep
          - Bash
          - WebSearch
          - WebFetch
        instruction: coderabbit-review
        output_contracts:
          report:
            - name: 07-coderabbit-review.md
              format: coderabbit-review
        rules:
          - condition: approved
          - condition: needs_fix
    rules:
      - condition: all("approved")
        next: pekko-compat-review
      - condition: any("needs_fix")
        next: qa-fix

  - name: qa-fix
    edit: true
    persona: coder
    policy:
      - coding
      - testing
      - fraktor-coding
    session: refresh
    knowledge:
      - pekko-porting
      - architecture
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Edit
      - Write
      - Bash
      - WebSearch
      - WebFetch
    required_permission_mode: edit
    pass_previous_response: false
    instruction: fix
    instruction_template: |
      **QA観点の指摘への対応:**
      QAレビューとCoderabbitレビューの指摘を優先的に解消すること。

      - QAレビュー由来の指摘: `06-qa-review.md`
      - Coderabbit由来の指摘: `07-coderabbit-review.md`

      **修正完了条件（必須）:**
      修正後に必ず以下を順番に実行し、全チェックがパスすることを確認してからレポートに記録すること:
      1. `./scripts/ci-check.sh dylint` （Dylint全lint）
      2. `./scripts/ci-check.sh all` （全CI）
      成功ログをcoder-decisionsレポートの「実行結果」セクションに含めること。
    rules:
      - condition: 修正完了（ci-check.sh all 通過済み）
        next: reviewers
      - condition: 判断できない、情報不足
        next: reviewers

  - name: pekko-compat-review
    edit: false
    persona: pekko-compat-reviewer
    policy:
      - review
      - pekko-compat
    knowledge:
      - pekko-porting
      - architecture
    allowed_tools:
      - Read
      - Glob
      - Grep
      - WebSearch
      - WebFetch
    instruction: review-pekko-compat
    output_contracts:
      report:
        - name: 05-pekko-compat-review.md
          format: pekko-compat-review
    rules:
      - condition: approved
        next: supervise
      - condition: needs_fix
        next: pekko-compat-fix

  - name: pekko-compat-fix
    edit: true
    persona: coder
    policy:
      - coding
      - testing
      - fraktor-coding
    session: refresh
    knowledge:
      - pekko-porting
      - architecture
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Edit
      - Write
      - Bash
      - WebSearch
      - WebFetch
    required_permission_mode: edit
    pass_previous_response: false
    instruction: fix
    instruction_template: |
      **Pekko互換性の指摘への対応:**
      pekko-compat-review の指摘がある場合は、必ず `references/pekko/` の
      該当ソースを読み直してからRust実装を修正すること。

      **修正完了条件（必須）:**
      修正後に必ず以下を順番に実行し、全チェックがパスすることを確認してからレポートに記録すること:
      1. `./scripts/ci-check.sh dylint` （Dylint全lint）
      2. `./scripts/ci-check.sh all` （全CI）
      成功ログをcoder-decisionsレポートの「実行結果」セクションに含めること。
    rules:
      - condition: 修正完了（ci-check.sh all 通過済み）
        next: pekko-compat-review
      - condition: 判断できない、情報不足
        next: pekko-compat-review

  - name: supervise
    edit: false
    persona: supervisor
    policy:
      - review
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Bash
      - WebSearch
      - WebFetch
    pass_previous_response: false
    instruction: supervise
    instruction_template: |
      **fraktor-rs固有の検証:**
      - qa-fix / pekko-compat-fix / implement ムーブメントのレポートに `./scripts/ci-check.sh all` の成功ログが記録されていることを確認
      - `06-qa-review.md` の判定がapprovedであることを確認
      - `07-coderabbit-review.md` の判定がapprovedであることを確認
      - `05-pekko-compat-review.md` の承認済み判定があることを確認
      - `qa-fix` / `pekko-compat-fix` の修正内容が上記レビュー結果と矛盾していないことを確認
      ※ supervisorはCIを自身では実行しない（qa-fix/pekko-compat-fix/implementの実行済み証跡をレポートで確認するのみ）
    output_contracts:
      report:
        - name: supervisor-validation.md
          format: supervisor-validation
        - name: summary.md
          format: summary
          use_judge: false
    rules:
      - condition: すべて問題なし
        next: COMPLETE
      - condition: テスト失敗、ビルドエラー、要件未達（修正で解決可能）
        next: pekko-compat-fix
      - condition: 根本的な設計変更が必要
        next: plan
