name: stub-elimination
description: "fraktor-rs streams スタブ撲滅 - Pekko準拠の完全実装に置換"
piece_config:
  provider_options:
    codex:
      network_access: true
max_movements: 25
initial_movement: analyze

knowledge:
  stub-elimination: ../facets/knowledge/stub-elimination.md
  fraktor-streams: ../facets/knowledge/fraktor-streams.md

policies:
  fraktor-coding: ../facets/policies/fraktor-coding.md

movements:
  - name: analyze
    edit: false
    persona: planner
    provider: codex
    model: gpt-5.3-codex
    knowledge:
      - stub-elimination
      - fraktor-streams
    instruction: plan
    rules:
      - condition: "requirements are clear and implementation is possible"
        next: implement
    output_contracts:
      report:
        - name: 00-analysis.md
          format: |
            # 分析
            ## 対象スタブ
            ## 設計方針
            ## 実装計画

  - name: implement
    edit: true
    persona: coder
    provider: codex
    model: gpt-5.3-codex-spark
    knowledge:
      - stub-elimination
      - fraktor-streams
    policy:
      - fraktor-coding
    instruction: implement
    rules:
      - condition: "implementation is complete"
        next: reviewers
    output_contracts:
      report:
        - name: coder-scope.md
          format: |
            # スコープ
            ## 変更ファイル
            ## 実装したスタブ
        - name: coder-decisions.md
          format: |
            # 設計判断
            ## 主要な判断

  - name: reviewers
    parallel:
      - name: ai_review
        edit: false
        persona: ai-antipattern-reviewer
        provider: codex
        model: gpt-5.3-codex
        instruction: review-ai
        policy:
          - fraktor-coding
        rules:
          - condition: approved
          - condition: needs_fix
        output_contracts:
          report:
            - name: codex-ai-review.md
              format: |
                # Codex AI Review
                ## Verdict
                ## Issues Found
      - name: supervise
        edit: false
        persona: supervisor
        provider: codex
        model: gpt-5.3-codex
        instruction: supervise
        policy:
          - fraktor-coding
        rules:
          - condition: approved
          - condition: needs_fix
        output_contracts:
          report:
            - name: supervisor-validation.md
              format: |
                # Supervisor Validation
                ## Verdict
                ## Issues Found
    rules:
      - condition: all("approved")
        next: COMPLETE
      - condition: any("needs_fix")
        next: fix_both

  - name: fix_both
    edit: true
    persona: coder
    provider: codex
    model: gpt-5.3-codex-spark
    knowledge:
      - stub-elimination
      - fraktor-streams
    policy:
      - fraktor-coding
    instruction: fix-supervisor
    pass_previous_response: true
    rules:
      - condition: "fix is complete"
        next: reviewers
    output_contracts:
      report:
        - name: fix-report.md
          format: |
            # 修正レポート
            ## 対処した問題
            ## 変更内容
