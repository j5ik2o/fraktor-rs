# 設計ドキュメントテンプレート

---
**目的**: 実装者間の解釈ずれを防ぎ、実装の一貫性を担保するための設計情報を提供する。

**方針**:
- 実装判断に直結するセクションのみを残す
- 誤実装を誘発しない範囲で簡潔に書く
- 複雑さに応じて詳細度を調整する
- 長文より図・表を優先する
- Rust 向けに **型・所有権・エラー・no_std/std 境界** を明示する

**警告**: 1000 行に近づく場合、機能が過剰に複雑であり設計の簡素化が必要。
---

> セクションは順序を入れ替えてよい（例: 要件トレーサビリティを前倒し）。各セクション内は **Summary → Scope → Decisions → Impacts/Risks** の流れを保つ。

## 概要
2〜3段落以内。
**目的**: この機能は [誰] に [どの価値] を提供する。  
**利用者**: [対象ユーザ] が [具体的な利用フロー] に使う。  
**影響**: 既存の [状態] を [どのように変更] する。

### 目標
- 主目標1
- 主目標2
- 成功条件

### 非目標
- 対象外の機能
- 将来対応で今はやらないこと
- 先送りする統合ポイント

## アーキテクチャ

> 詳細な探索メモが `research.md` にある場合も、設計判断と契約は必ず design.md に書く。
> 同じ内容の重複記述は避け、図で構造を示し本文は要点に留める。

### 既存アーキテクチャ分析（必要な場合）
- 現状の構成・制約
- 既存の境界・依存方向
- 維持すべき統合点
- 技術的負債の扱い

### パターンと境界マップ
**推奨**: 複雑な機能では Mermaid 図（境界/層/責務）を必須とする

**アーキテクチャ統合**
- 選択したパターン: [名称と理由]
- 境界の切り方: [責務衝突を避けるための分離]
- 既存パターンの維持: [重要なパターン]
- 新規コンポーネントの理由: [必要性]
- ステアリング適合: [守る原則]

### 技術スタック

| レイヤ | 選定 / バージョン | 役割 | 備考 |
|-------|------------------|------|------|
| ランタイム / 実行基盤 | | | |
| データ / 永続化 | | | |
| メッセージング / イベント | | | |
| 監視 / メトリクス | | | |
| 互換性 / シリアライズ | | | |

> トレードオフや調査結果が必要なら、要点だけ本文に書き、詳細は Supporting References または `research.md` に回す。

## システムフロー

非自明なフローのみ Mermaid 図を載せる。
- シーケンス（複数コンポーネントの相互作用）
- 状態遷移（分岐/ライフサイクル）
- データ/イベントフロー（非同期パイプライン）

単純な CRUD なら省略してよい。

## 要件トレーサビリティ

要件が複数の領域にまたがる場合に必須。1:1 で対応するなら省略可。

| 要件 | 概要 | 対応コンポーネント | インターフェイス | フロー |
|------|------|--------------------|------------------|--------|
| 1.1 | | | | |
| 1.2 | | | | |

## コンポーネントとインターフェイス

最初に全体の要約テーブルを置く。

| コンポーネント | ドメイン/層 | 目的 | 要件対応 | 主要依存 (P0/P1) | 契約 |
|---------------|------------|------|----------|------------------|------|
| Example | Core | 役割 | 1,2 | A(P0), B(P1) | Service, Event |

### [ドメイン / 層]

#### [コンポーネント名]

| 項目 | 内容 |
|------|------|
| 目的 | 1行で責務を説明 |
| 対応要件 | 2.1, 2.3 |
| オーナー/レビュー | （任意） |

**責務と制約**
- 主責務
- 境界とトランザクション範囲
- 不変条件
- no_std/std 境界（あれば明記）

**依存関係**
- Inbound: 依存元 — 目的（重要度）
- Outbound: 依存先 — 目的（重要度）
- External: 外部サービス/ライブラリ — 目的（重要度）

**契約**: Service [ ] / API [ ] / Event [ ] / Batch [ ] / State [ ]

##### サービスインターフェイス（Rust）
```rust
pub trait ExampleService {
  fn handle(&mut self, input: InputType) -> Result<OutputType, ErrorType>;
}
```
- 前提条件:
- 事後条件:
- 不変条件:

##### API 契約（必要な場合）
| Method | Endpoint | Request | Response | Errors |
|--------|----------|---------|----------|--------|
| POST | /api/resource | CreateRequest | Resource | 400, 409, 500 |

##### イベント契約
- 発行イベント:
- 購読イベント:
- 並び順 / 配送保証:

##### バッチ/ジョブ契約
- トリガ:
- 入力/検証:
- 出力/宛先:
- 冪等性/回復:

##### 状態管理
- 状態モデル:
- 永続化/整合性:
- 競合制御（所有権/ロック/排他）:

**実装ノート**
- 統合ポイント:
- バリデーション:
- リスク:

## データモデル

変更がある部分のみ記載。

### ドメインモデル
- 集約と境界
- エンティティ/値オブジェクト/ドメインイベント
- 不変条件
- 必要なら Mermaid 図

### 論理データモデル
- 関係/カーディナリティ
- 属性と型
- 識別子/キー
- 整合性ルール

### 物理データモデル（必要な場合）
- テーブル/コレクション/キー設計
- インデックス
- 分割/スケール戦略

### データ契約と連携
- API DTO（シリアライズ形式）
- イベントスキーマ（バージョニング）
- 分散整合性（Saga/補償/最終整合）

## エラーハンドリング

### 方針
- Rust の `Result`/`Error` 型の構成
- 回復可能/致命的の区別
- 伝播境界（API/イベント/ログ）

### エラー分類と応答
**入力系**: 不正入力 → 明確な拒否理由  
**システム系**: IO/タイムアウト → リトライ/フォールバック  
**ビジネス系**: 状態遷移違反 → 状態説明  

**必要な場合のみ**: 複雑なエラー分岐は Mermaid で可視化。

### 監視
- 例外/失敗イベント
- 重要メトリクス
- ヘルスチェック

## テスト戦略

- 単体テスト: 3〜5項目
- 統合テスト: 3〜5項目
- E2E/シナリオ（あれば）
- パフォーマンス/負荷（必要なら）
- no_std/std の差分検証（必要なら）

## オプション（必要な場合のみ）

### セキュリティ
- 認可/認証
- データ保護
- 脅威モデル

### 性能/スケーラビリティ
- 目標指標
- ボトルネック回避策
- キャッシュ/バッチ戦略

### マイグレーション
- 段階/ロールバック
- Mermaid 図で移行フロー

## Supporting References（必要な場合のみ）
- 本文に入れると読みにくくなる長大な詳細（比較表/巨大な型定義など）
- 結論は本文に残し、補足資料はここへ
