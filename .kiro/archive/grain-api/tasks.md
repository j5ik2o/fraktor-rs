# Implementation Plan

- [ ] 1. Grain 参照と解決の基盤を整備する
- [x] 1.1 Grain 参照型と解決結果に識別情報を保持させる
  - kind/identity を保持する参照型を導入し、参照結果に識別情報を含める
  - 参照解決の入口を統一して利用者の呼び出し手順を簡素化する
  - _Requirements: 1.1, 1.5_
- [x] 1.2 未起動・未登録・未確定を区別できる解決エラーを整備する
  - 参照解決の失敗理由を判別可能にし、未確定状態を呼び出し側で識別できるようにする
  - 失敗理由が観測イベントに反映される前提を整える
  - _Requirements: 1.2, 2.5_
- [x] 1.3 トポロジ更新に追随した決定的な解決を維持する
  - 更新後のトポロジに基づく解決結果を返し続ける条件を満たす
  - 同一識別子に対して決定的な結果が返ることを担保する
  - _Requirements: 1.3, 1.4_

- [ ] 2. Grain 呼び出しポリシーと送達フローを構築する
- [x] 2.1 タイムアウトとリトライの呼び出しポリシーを定義する
  - no_std で利用可能な呼び出しポリシーを定義する
  - リトライ対象と最大回数を設定可能にする
  - _Requirements: 2.3, 2.4_
- [x] 2.2 呼び出し送達・応答返却・再試行を統合する
  - 参照解決後にアクティベーションへ送達し、応答を返す
  - タイムアウトと未確定状態の再試行をポリシーに従って実行する
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 3. Grain 実行コンテキストを提供する
- [x] 3.1 実行開始時に識別情報とクラスタ参照を取得できるようにする
  - kind/identity を参照可能にする
  - クラスタ参照を取得できる手段を用意する
  - _Requirements: 3.1, 3.2, 3.4_
- [x] 3.2 実行終了時にコンテキスト利用を終了させる
  - 実行の終了に合わせて文脈の参照が終了することを保証する
  - _Requirements: 3.3_

- [ ] 4. メッセージ表現と互換性の扱いを整備する
- [x] 4.1 シリアライザ登録・未登録・互換性不一致の扱いを統一する
  - 登録済みシリアライザでエンコード/デコードできることを保証する
  - 未登録や互換性不一致の失敗を通知できるようにする
  - _Requirements: 4.1, 4.2, 4.4_
- [x] 4.2 非 protobuf の送受信を Grain 呼び出し経路に統合する
  - protobuf 固定ではないメッセージ表現でも送受信が成立することを保証する
  - 呼び出し経路にメッセージ変換の適用点を組み込む
  - _Requirements: 4.1, 4.3_

- [x] 5. 観測性とメトリクスを整備する
- [x] 5.1 Grain 呼び出し失敗をイベントとして通知する
  - 失敗/タイムアウト/再試行を観測イベントとして発火する
  - _Requirements: 5.1_
- [x] 5.2 アクティベーション観測とメトリクス更新を統合する
  - アクティベーション生成/パッシベートの観測経路を整える
  - メトリクス有効時の更新と無効時の拒否を明確化する
  - _Requirements: 5.2, 5.3, 5.4_

- [x] 6. std 拡張と環境整合を仕上げる
- [x] 6.1 std 環境の呼び出し既定値と補助機能を提供する
  - std 環境向けの既定ポリシーと利便機能を提供する
  - _Requirements: 6.2_
- [x] 6.2 no_std と std の挙動差を最小化する
  - 共通ポリシーを適用し、環境差異の影響を小さくする
  - _Requirements: 6.1, 6.3_

- [x] 7. Grain API のサンプルを更新する
- [x] 7.1 既存の std サンプルを Grain API で動作させる
  - 参照取得と呼び出しが確認できるサンプルに更新する
  - 更新後も実行可能であることを確認する
  - _Requirements: 7.1, 7.2_
- [x] 7.2 no_std 向けサンプルでも成功シナリオを再現する
  - no_std 環境で参照取得と呼び出しが成立することを示す
  - 成功シナリオを再現できることを確認する
  - _Requirements: 7.1, 7.2, 7.3_

- [x] 8. テストで要件を検証する
- [x] 8.1 参照解決と呼び出しポリシーの単体テストを追加する
  - 未起動/未登録/未確定の判定を検証する
  - タイムアウト/リトライのポリシー挙動を検証する
  - _Requirements: 1.2, 2.3, 2.4, 2.5_
- [x] 8.2 メッセージ互換性と観測イベントの統合テストを追加する
  - メッセージ互換性の成功/失敗を検証する
  - 失敗イベントとメトリクス更新の発火を検証する
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 5.1, 5.3, 5.4_
- [x] 8.3 no_std/std の挙動差とサンプル成功を検証する
  - no_std で core API が利用可能であることを検証する
  - std で拡張機能が利用可能であることを検証する
  - _Requirements: 6.1, 6.2, 6.3_
