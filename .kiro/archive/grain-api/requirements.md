# 要件ドキュメント

## 導入
本仕様は Grain API の導入により、仮想アクターを kind/identity で参照・呼び出しできる利用体験を提供することを目的とする。
メッセージ表現は protobuf 固定ではなく拡張可能であること、no_std と std の両環境で一貫した API を提供できること、
および利用者向けのサンプルコードを提供することを要件として定義する。

## 要件

### 要件1: Grain 識別と参照解決
**目的:** アプリケーション開発者として kind/identity で Grain を参照し、仮想アクターを透過的に利用したい。

#### 受け入れ条件
1. Grain の kind と identity が指定されたとき、Grain API は対象の Grain 参照を解決しなければならない。
2. クラスタが未起動ならば、Grain API は参照解決を拒否しなければならない。
3. トポロジ更新中の間、Grain API は最新トポロジに基づく参照解決結果を返し続けなければならない。
4. 複数ノードが存在する場合、Grain API は同一の識別子に対して決定的な参照解決結果を返し続けなければならない。
5. Grain API は常に参照解決結果に Grain 識別情報を含めなければならない。

### 要件2: Grain 呼び出しと応答
**目的:** クラスタ利用者として Grain を呼び出して応答を得ることで、仮想アクターを API のように扱いたい。

#### 受け入れ条件
1. Grain 呼び出しが行われたとき、Grain API は解決済みのアクティベーションへ要求を送達しなければならない。
2. 応答が受信されたとき、Grain API は呼び出し元へ応答を返しなければならない。
3. タイムアウトが発生したならば、Grain API は呼び出し元へタイムアウトを通知しなければならない。
4. リトライ設定を含む場合、Grain API は設定回数まで再試行しなければならない。
5. 配置が未確定の間、Grain API は呼び出し失敗を通知し続けなければならない。

### 要件3: Grain 実行コンテキスト
**目的:** Grain 実装者として処理中に識別情報とクラスタ参照を取得し、実行時の文脈を安全に扱いたい。

#### 受け入れ条件
1. Grain の処理が開始されたとき、Grain API は kind と identity を参照可能にしなければならない。
2. Grain の処理中の間、Grain API はクラスタ参照を利用可能にし続けなければならない。
3. Grain の処理が終了したとき、Grain API は実行コンテキストの利用を終了させなければならない。
4. Grain API は常に Grain 実行コンテキストを取得できる手段を提供しなければならない。

### 要件4: メッセージ表現と互換性
**目的:** インテグレーション担当として protobuf 固定ではないメッセージ表現で Grain 呼び出しを行い、既存のシリアライザと共存したい。

#### 受け入れ条件
1. シリアライザが登録されたとき、Grain API は登録済みシリアライザでメッセージをエンコード/デコードしなければならない。
2. シリアライザが未登録ならば、Grain API は送受信の失敗を通知しなければならない。
3. メッセージ表現が protobuf 以外であるとき、Grain API は送受信を成立させなければならない。
4. 互換性のないメッセージが到着したならば、Grain API は互換性不一致を通知しなければならない。

### 要件5: 観測性と失敗通知
**目的:** 運用者として Grain 呼び出しとアクティベーションの状態を観測し、障害原因の特定を容易にしたい。

#### 受け入れ条件
1. Grain 呼び出しが失敗したとき、Grain API は観測可能なイベントを通知しなければならない。
2. アクティベーションが生成またはパッシベートされたとき、Grain API は観測可能なイベントを通知しなければならない。
3. メトリクスが有効な場合、Grain API は呼び出し/アクティベーションに関するメトリクスを更新しなければならない。
4. メトリクスが無効な場合、Grain API はメトリクス取得要求を拒否しなければならない。

### 要件6: 対応環境
**目的:** ランタイム開発者として no_std と std の両環境で Grain API を運用し、同一の利用体験を維持したい。

#### 受け入れ条件
1. 標準ライブラリが利用できない環境の間、Grain API は core API を利用可能にし続けなければならない。
2. 標準ライブラリが利用できる場合、Grain API は std 環境で利用可能な拡張機能を提供しなければならない。
3. 同一の Grain 呼び出しフローに対して、Grain API は環境差異による振る舞いの差を最小化しなければならない。

### 要件7: サンプルコード
**目的:** 利用者として Grain API の使用例を参照し、導入と検証を迅速に進めたい。

#### 受け入れ条件
1. サンプルコードを提供するとき、サンプルコードは Grain の参照取得と呼び出しを示さなければならない。
2. 既存サンプルを修正する場合、サンプルコードは更新後も実行可能でなければならない。
3. サンプルコードが実行されたとき、サンプルコードは Grain API の成功シナリオを再現しなければならない。
