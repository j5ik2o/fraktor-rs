# 実装計画

- [x] 1. 配置決定のコア機能を整備
  - _対応要件: 1.1, 1.2, 1.3, 1.4, 1.5_
  - _依存タスク: -_
- [x] 1.1 ルックアップ時の配置決定とローカル/リモート分岐を実装
  - ルックアップ要求からパーティションと担当ノードを決定する
  - リモート担当の場合はアドレスのみ返し、アクティベーション処理を行わない
  - ローカル担当の場合は後続処理のためのコマンド列を生成する
  - 同一入力に対して決定的な配置結果を返す
  - _対応要件: 1.1, 1.4_
  - _依存タスク: -_
  - _完了条件: ローカル/リモートの分岐が一貫して行われる_
- [x] 1.2 トポロジ更新とスナップショット参照を実装
  - トポロジ変更を受け取り、以降の配置決定に反映する
  - 配置情報のスナップショットを参照可能にする
  - トポロジ更新による配置決定の一貫性を確認する
  - _対応要件: 1.2, 1.5_
  - _依存タスク: 1.1_
  - _完了条件: トポロジ変更後も配置決定が正しく更新される_
- [x] 1.3 未確定/未起動時の拒否を実装
  - 未起動状態ではルックアップ要求を拒否する
  - 配置情報が未確定の間は保留として扱う
  - 保留時に再試行可能な応答を返す
  - _対応要件: 1.3, 4.3_
  - _依存タスク: 1.1_
  - _完了条件: 未確定/未起動時に正しく拒否または保留できる_

- [x] 2. 分散アクティベーションの排他制御を整備
  - _対応要件: 2.1, 2.2, 2.3, 2.4, 2.5, 3.1, 3.2, 3.3, 3.4, 3.5_
  - _依存タスク: 1.1_
- [x] 2.1 ロック取得と解放のフローを実装
  - アクティベーション開始前に排他的ロックを取得する
  - ロック取得に失敗した場合はアクティベーションを開始しない
  - 処理の完了または失敗時にロックを解放する
  - _対応要件: 2.1, 3.1, 3.2, 3.5_
  - _依存タスク: 1.1_
  - _完了条件: ロック取得と解放が必ず実行される_
- [x] 2.2 ストレージの所有者情報と整合性を実装
  - ロック保持中に所有者情報と状態を一貫して保持する
  - 既存の所有者情報を読み取り、整合性を確認する
  - 永続化が必要な場合に状態を保存する
  - _対応要件: 3.3, 3.4_
  - _依存タスク: 2.1_
  - _完了条件: 所有者情報が一貫して保持される_
- [x] 2.3 既存アクティベーションの再利用を実装
  - 既存のアクティベーションがある場合は新規生成しない
  - 同一 ID に対する同時アクティベーションを防止する
  - 再利用時の参照を正しく返す
  - _対応要件: 2.2, 2.5_
  - _依存タスク: 2.2_
  - _完了条件: 同一 ID の重複起動が発生しない_
- [x] 2.4 不適格時の拒否と失敗理由通知を実装
  - ノードが不適格な場合はアクティベーションを拒否する
  - 失敗時に理由を通知できるようにする
  - 拒否/失敗のイベントを観測可能にする
  - _対応要件: 2.3, 2.4_
  - _依存タスク: 2.1_
  - _完了条件: 不適格時の拒否と失敗理由通知が行われる_

- [x] 3. 非同期 I/O 委譲と相関制御を整備
  - _対応要件: 2.1, 2.4, 3.1, 3.2, 3.4, 3.5_
  - _依存タスク: 1.1_
- [x] 3.1 I/O コマンド生成と相関 ID 付与を実装
  - ローカル担当時に I/O 実行コマンドを生成する
  - すべてのコマンドに相関 ID を付与する
  - コマンド生成の順序と意図を保つ
  - _対応要件: 2.1, 3.1, 3.2_
  - _依存タスク: 1.1_
  - _完了条件: 相関 ID が付与されたコマンドが生成される_
- [x] 3.2 非同期実行結果の相関と返却を実装
  - I/O 実行結果に同じ相関 ID を付与して返す
  - 結果を元に次の状態へ遷移させる
  - 失敗結果が通知されることを確認する
  - _対応要件: 2.4, 3.2, 3.4, 3.5_
  - _依存タスク: 3.1_
  - _完了条件: 実行結果が相関 ID 付きで正しく処理される_
- [x] 3.3 保留状態の再試行制御を実装
  - I/O 実行中は保留応答として扱う
  - 再試行時に同一結果へ収束するようにする
  - 冪等性が維持されることを確認する
  - _対応要件: 1.3, 2.1_
  - _依存タスク: 3.2_
  - _完了条件: 保留状態からの再試行が成立する_

- [x] 4. ライフサイクルと観測性を整備
  - _対応要件: 4.1, 4.2, 4.3, 4.4, 4.5_
  - _依存タスク: 1.3_
- [x] 4.1 起動/停止時の状態遷移を実装
  - メンバーモード起動時に稼働状態へ遷移させる
  - 停止要求時に状態を停止へ移行させる
  - 状態変化が一貫して反映されることを確認する
  - _対応要件: 4.1, 4.2_
  - _依存タスク: 1.3_
  - _完了条件: 起動/停止の状態遷移が正しく反映される_
- [x] 4.2 イベント通知とタイムスタンプ付与を実装
  - 主要な状態遷移/失敗をイベントとして通知する
  - すべてのイベントにタイムスタンプを付与する
  - 失敗理由がイベントに含まれることを確認する
  - _対応要件: 2.4, 4.4, 4.5_
  - _依存タスク: 2.4_
  - _完了条件: 主要イベントがタイムスタンプ付きで通知される_

- [x] 5. テストで機能と境界を検証
  - _対応要件: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 2.3, 2.4, 2.5, 3.1, 3.2, 3.3, 3.4, 3.5, 4.1, 4.2, 4.3, 4.4, 4.5_
  - _依存タスク: 4.2_
- [x] 5.1 ユニットテストを追加
  - ローカル/リモート分岐の挙動を検証する
  - 未起動/保留時の拒否を検証する
  - 既存アクティベーション再利用と重複防止を検証する
  - 相関 ID による結果適用を検証する
  - _対応要件: 1.1, 1.3, 2.2, 2.5, 3.1_
  - _依存タスク: 2.3_
  - _完了条件: ユニットテストがすべて通る_
- [x] 5.2 統合テストを追加
  - トポロジ更新が配置決定へ反映されることを検証する
  - ロック/ストレージ/アクティベーションの一連フローを検証する
  - イベント通知とタイムスタンプ付与を検証する
  - 保留状態からの再試行フローを検証する
  - _対応要件: 1.2, 1.5, 2.1, 3.3, 4.4, 4.5_
  - _依存タスク: 4.2_
  - _完了条件: 統合テストがすべて通る_
