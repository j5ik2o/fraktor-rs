# 実装計画

- [ ] 0. ActorSystemBuilder / Bootstrap を整備する
  - _(親タスクなので詳細は記載しない)_
  - _対応要件: R1.1, R1.3, R3.1, R4.1, R4.5, R4.7_
  - _依存タスク: -_
- [x] 0.1 ActorSystemBuilder を実装し TickDriverConfig を受け取れるようにする
  - `ActorSystemBuilder<TB>` / `ActorSystemBootstrap`（名称は最終決定に追従）を追加し、Props・Toolbox・TickDriverConfig をビルドチェーンで設定可能にする
  - `build()` 時に TickDriverBootstrap を呼び出し、ActorSystem 起動前に構成検証とエラー整形を行う
  - no_std / std 共通で 20 行以内の初期化テンプレートに落とし込める API 表面を整える
  - _対応要件: R1.1, R3.1, R4.1, R4.5, R4.7_
  - _依存タスク: 0_
- [x] 0.2 Builder 初期化経路にランタイムメタデータと Runner API ガードを統合する
  - Builder で選択された TickDriverMetadata を `SystemState` / `EventStream` に書き込み、Runner API 無効化設定も同時に適用する
  - ManualTestDriver を Builder からしか注入できないようにし、`cfg(test)` 以外での利用をビルド時に弾く
  - _対応要件: R1.3, R3.1, R3.5, R3.6_
  - _依存タスク: 0.1_
- [ ] 0.3 Quickstart / examples を ActorSystemBuilder ベースへ更新する
  - [x] `modules/actor-core/examples/**/scheduler_*_no_std` / typed 版を全て Builder 呼び出しに差し替え、Runner API 依存を排除する
  - [ ] `docs/guides/tick-driver-quickstart.md` のコードスニペットを最新の Builder API（`with_tick_driver(...)` 等）へ差し替え、main 関数 20 行以内を実証する
  - _対応要件: R4.1, R4.2, R4.5, R4.6, R4.7_
  - _依存タスク: 0.1, 0.2_

- [ ] 1. Tickドライバ基盤を整備
  - _(親タスクなので詳細は記載しない)_
  - _対応要件: R1.1, R1.2, R1.3, R1.5, R2.1, R2.2, R2.3, R3.6_
  - _依存タスク: -_
- [x] 1.1 Tickドライバ設定とビルダー接続を整える
  - 自動・ハードウェア・テスト各モードを切り替えられる設定コンテキストを用意し、解像度やメトリクス公開間隔、フェイルオーバーポリシーを保持できるようにする
  - ActorSystem 初期化フローに設定検証を組み込み、禁止組み合わせや不足パラメータを確実に弾いて起動前にエラーとして返す
  - 選択されたドライバ種別と解像度をランタイムメタデータへ記録し、後段の監視コードや Quickstart ガイドで参照できるようにする
  - _対応要件: R1.1, R2.1, R3.1, R3.4, R3.6, R4.5_
  - _依存タスク: -_
- [x] 1.2 Tick フィードと実行ループを統合する
  - Tick を保持するリングバッファと順序保証ロジックを実装し、供給側とスケジューラ側の速度差を平準化する
  - ドライバとスケジューラの間に通知シグナルを追加し、バックプレッシャーや過負荷時のドロップ計測を含めた制御フローを構築する
  - バックグラウンド実行ループを確立し、スケジューラ駆動用のワーカを actor workload と分離して起動する
  - _対応要件: R1.2, R1.4, R2.2, R3.5_
  - _依存タスク: 1.1_
- [x] 1.3 ドライバ健全性とメトリクスを監視する
  - ホストタイマ登録・ドライバ停止・ISR 無効化などを検知し、即時に起動中止や再試行を行うエラー判定を実装する
  - リトライやバックオフを含むフォールバック制御を整備し、連続失敗時にはシステム終了へ切り替えるフローを明示する
  - 1 秒間の Tick 発行数・ドロップ数・ドリフト率を測定して EventStream へ発行し、±5% を超えた場合に警告を送る監視を追加する
  - _対応要件: R1.2, R1.3, R1.5, R2.3, R3.6_
  - _依存タスク: 1.2_

- [x] 2. Std 自動 Tick ドライバを統合する
  - _(親タスクなので詳細は記載しない)_
  - _対応要件: R1.1, R1.2, R1.3, R1.4, R1.5, R3.4_
  - _依存タスク: 1.1, 1.2, 1.3_
- [x] 2.1 ホストランタイム自動検出を実装する
  - ランタイムからホストタイマを検出して自動ドライバファクトリへ橋渡しするロケータを用意し、必要に応じて明示指定を受け取るバイパス経路も備える
  - ハンドル取得やタスク登録が失敗した場合は即座に起動を中止し、原因と推奨設定を含むエラーを返す
  - 自動検出結果を構成メタデータへ記録し、新しいドライバ登録経路でもデフォルト値として選ばれるようにする
  - _対応要件: R1.1, R1.3, R3.4_
  - _依存タスク: 1.1_
- [x] 2.2 Tokio ベースの Tick 供給タスクを駆動する
  - 専用バックグラウンドタスクでタイマループを起動し、アクター処理とは独立した実行コンテキストで Tick を供給する
  - タイマ解像度と Missed Tick の挙動を調整し、±5% の精度要件を満たすように遅延補正ロジックを実装する
  - 実行タスクとスケジューラ間の競合を検知するテストを追加し、Tick が途切れず供給されることを確認する
  - _対応要件: R1.2, R1.4_
  - _依存タスク: 2.1, 1.2_
- [x] 2.3 Std 環境向けメトリクス配信と検証を行う
  - 自動ドライバから得た Tick 統計を 1 秒ごとに集計し、EventStream にホスト環境向けの測定値を送るフローを実装する
  - ±5% の許容範囲を逸脱した場合に警告イベントを生成し、原因解析のためのドライバ ID と解像度を付与する
  - 統計イベントを購読するテストサブスクライバを用意し、Tick 数とドロップ数が期待通りに通知されることを検証する
  - _対応要件: R1.5_
  - _依存タスク: 2.2, 1.3_

- [x] 3. 組込み向け Tick ドライバ抽象を整備する
  - _(親タスクなので詳細は記載しない)_
  - _対応要件: R2.1, R2.2, R2.3, R2.4, R2.5_
  - _依存タスク: 1.1, 1.2, 1.3_
- [x] 3.1 ハードウェアドライバ抽象と登録経路を実装する
  - タイマ開始・停止・割り込み登録をカプセル化するドライバ抽象を定義し、ビルダーから静的参照として受け取れるようにする
  - 複数種類のハードウェアタイマを差し替えられるレジストリやファクトリ構造を導入し、切り替え時の検証ロジックを追加する
  - 解像度やサポート機能を構成メタデータへ書き込み、他環境との挙動比較に利用できるようにする
  - _対応要件: R2.1, R2.4_
  - _依存タスク: 1.1_
- [x] 3.2 ISR から Tick フィードへの橋渡しを実装する
  - 割り込みハンドラ内での Tick 注入をクリティカルセクション化し、供給順序と再入を安全に扱う
  - ドライバが停止または応答しなくなった際に検出できるウォッチドッグを追加し、フォールバックポリシーに従って通知する
  - 模擬タイマを用いたテストで FIFO 順序・ドロップ計測・停止時の通知が期待通り動作することを確認する
  - _対応要件: R2.2, R2.3_
  - _依存タスク: 3.1, 1.2, 1.3_
- [x] 3.3 テスト専用の手動ドライバを提供する
  - 手動で Tick を注入できるフックをテスト限定で公開し、決定論的シナリオを再現できるようにする
  - Tick Executor を生成しない構成フラグを設け、手動モード中は自動タスクが起動しないことを保証する
  - テストプロファイルでのみコンパイルされることと、no_std・std いずれでもシミュレーション操作が可能であることを検証する
  - _対応要件: R2.5, R3.3, R3.5_
  - _依存タスク: 1.2_

- [ ] 4. Runner API をテスト専用に閉じ込める
  - _(親タスクなので詳細は記載しない)_
  - _対応要件: R3.1, R3.2, R3.3, R3.4, R3.5, R3.6_
  - _依存タスク: 1.1, 1.2, 1.3, 2.1, 3.3_
- [x] 4.1 本番構成ガードと自動選択を実装する
  - ビルダーに構成検証を追加し、本番モードでは自動またはハードウェアドライバのみ受理するようにする
  - 新しい自動ドライバが登録された際にも即座に既定候補へ切り替わる自動選択ロジックを用意する
  - 構成違反時には起動を拒否し、必要な設定キーと再構成手順を含むエラー情報を返す
  - _対応要件: R3.1, R3.4_
  - _依存タスク: 1.1, 2.1_
- [x] 4.2 Runner API の公開面をテストへ限定する
  - ランタイム API 表面をテストフラグ下に限定し、ビルド時に本番ターゲットから除外する
  - 実行時に Runner API が誤って呼ばれた場合は即時に構成エラーを返し、システム起動を停止するガードを追加する
  - テストビルドでのみ Runner API が利用でき、手動ドライバが自動タスクを無効化していることを統合テストで証明する
  - _対応要件: R3.2, R3.3, R3.5_
  - _依存タスク: 3.3, 4.1_
- [x] 4.3 稼働中ドライバのメタデータと監査ログを公開する
  - 現在稼働中のドライバ名・解像度・モードをランタイム設定メタデータに保持し、監視 API から取得できるようにする
  - 手動モードが無効な環境で検出された場合は EventStream へ警告を送る監査ログを追加する
  - メタデータとログが一致していること、および構成違反が確実に追跡できることをテストで確認する
  - _対応要件: R3.6_
  - _依存タスク: 1.3, 4.1_

- [ ] 5. Quickstart 用のランタイム資産を整備する
  - _(親タスクなので詳細は記載しない)_
  - _対応要件: R4.1, R4.2, R4.3, R4.4, R4.5, R4.6, R4.7_
  - _依存タスク: 1.1, 1.2, 2.2, 3.1, 3.3, 4.2_
- [x] 5.1 Std Quickstart テンプレートとビルダー補助を実装する
  - 自動ドライバ設定を数行で書けるビルダーヘルパを追加し、サンプルメイン関数を 20 行未満で完結させる
  - サンプルコードが ActorSystem 起動→ユーザアクター開始→終了まで自動 Tick で動作することを統合テストで確認する
  - Quickstart サンプルが Runner API に依存せず、設定チェーンで完結することを検証する
  - _対応要件: R4.1, R4.5, R4.6, R4.7_
  - _依存タスク: 2.2, 4.1_
- [x] 5.2 組込み Quickstart テンプレートを実装する
  - ハードウェアドライバを attach する手順と Tick Executor ポンプのループをテンプレート化し、最小限の初期化コードに整理する
  - 模擬タイマとスケジューラを使ったテストで、テンプレートが決定論的 Tick を維持できることを確認する
  - ドライバ交換ポイントへコメントを付与し、ユーザが固有タイマに差し替えやすい構造に整える
  - _対応要件: R4.2, R4.6_
  - _依存タスク: 3.2_
- [x] 5.3 テスト用 Quickstart とドライバ選択マトリクスを提供する
  - テスト専用の手動ドライバサンプルをテストフラグ下に分離し、Runner API を使った時間制御フローを例示する
  - 自動/ハードウェア/テスト各ドライバの特性をまとめたデータ構造を公開し、ドライバ選択マトリクスとして利用できるようにする
  - 上記データとランタイムメタデータが一致すること、テストサンプルが本番ビルドへ漏れないことを検証する
  - _対応要件: R3.2, R4.3, R4.4_
  - _依存タスク: 3.3, 4.2_
