# 実装計画

- [x] 1. Membership/Gossip 基盤のライフサイクルと基本入力を整備する
  - _対応要件: 1.1-1.5, 2.1-2.5_
  - _依存タスク: -_
- [x] 1.1 起動・停止と未起動時の拒否を確実化する
  - メンバーモード/クライアントモードの開始と停止の振る舞いを確定する
  - 未起動時は全入力を拒否し、状態変化が起きないことを保証する
  - 起動後のみ入力を受け付けるガードを一貫して適用する
  - _対応要件: 1.1, 1.2, 1.3_
  - _依存タスク: -_
  - _完了条件: 未起動時の入力がすべて失敗し、起動後のみ処理される_
- [x] 1.2 参加/離脱/生存確認の状態遷移を実装する
  - 参加要求で Joining を登録し、正しい順序で Up へ遷移させる
  - 離脱要求で Leaving/Removed へ遷移し、アクティブ集合から除外する
  - 不正な遷移要求を検出して拒否し、理由を記録する
  - _対応要件: 2.1, 2.2, 2.5_
  - _依存タスク: 1.1_
  - _完了条件: 正常遷移と無効遷移の検出が一貫して動作する_
- [x] 1.3 メンバー状態のスナップショットを提供する
  - 現在の Membership を読み取り専用で取得できるようにする
  - 未起動時は空スナップショットを返す挙動を保証する
  - _対応要件: 1.5_
  - _依存タスク: 1.1_
  - _完了条件: いつでも Membership の現在状態が取得できる_

- [x] 2. 失敗検知と隔離ルールを整備する
  - _対応要件: 2.3, 2.4, 3.1-3.5_
  - _依存タスク: 1.2_
- [x] 2.1 失敗検知の疑い/確定を状態遷移へ反映する
  - 疑いの検知で Suspect へ遷移させる
  - 疑いの解消で Up へ戻す
  - 疑いの確定で Dead へ遷移させる
  - _対応要件: 2.3, 2.4_
  - _依存タスク: 1.2_
  - _完了条件: 失敗検知の効果が状態遷移へ反映される_
- [x] 2.2 Dead 判定時に隔離を開始しイベントを発火する
  - Dead 判定時に隔離を開始し、隔離イベントを発火する
  - 隔離対象はアクティブメンバーから除外され続けるようにする
  - _対応要件: 3.1, 3.2_
  - _依存タスク: 2.1_
  - _完了条件: Dead 判定と隔離イベントが連動する_
- [x] 2.3 隔離中の再参加を拒否し理由を通知する
  - 隔離中の参加要求は拒否し、理由を返す
  - 隔離判定が最優先で適用されることを保証する
  - _対応要件: 3.3_
  - _依存タスク: 2.2_
  - _完了条件: 隔離中の再参加が必ず拒否される_
- [x] 2.4 隔離の期限満了と一覧参照を提供する
  - 隔離期限が満了したら再参加を許可する
  - 隔離対象の一覧を常に取得できるようにする
  - _対応要件: 3.4, 3.5_
  - _依存タスク: 2.2_
  - _完了条件: 隔離の解除と一覧取得が可能になる_

- [x] 3. Gossip とトポロジ更新の集約生成を整備する
  - _対応要件: 1.4, 4.1-4.3, 5.4_
  - _依存タスク: 1.2, 2.2_
- [x] 3.1 Gossip による Membership 更新の交換を実装する
  - 送受信の差分を処理し Membership 更新が伝播するようにする
  - 送信に失敗した場合はエラーとして扱えるようにする
  - _対応要件: 1.4_
  - _依存タスク: 1.2_
  - _完了条件: ピア間で Membership 更新が交換される_
- [x] 3.2 トポロジ更新の集約と無変更抑止を実装する
  - 同一周期の変更を集約して単一の更新を生成する
  - 変更がない場合は更新を生成しない
  - _対応要件: 4.2, 4.3_
  - _依存タスク: 1.2, 2.2_
  - _完了条件: 集約規則に従って更新が生成される_
- [x] 3.3 変更集合・メンバー一覧・タイムスタンプを更新に含める
  - 変更集合と現在のメンバー一覧を同時に通知できるようにする
  - トポロジ更新にタイムスタンプを付与する
  - _対応要件: 4.1, 5.4_
  - _依存タスク: 3.2_
  - _完了条件: TopologyUpdated に変更集合・メンバー一覧・時刻が含まれる_

- [x] 4. EventStream 配信とドライバ統合を行う
  - _対応要件: 1.4, 3.1-3.5, 5.2, 5.5_
  - _依存タスク: 2.4, 3.3_
- [x] 4.1 Coordinator の結果を EventStream へ配信する
  - トポロジ更新とメンバー状態変化を EventStream へ配信する
  - 購読者にイベントが確実に届くようにする
  - _対応要件: 5.2, 5.5_
  - _依存タスク: 3.3_
  - _完了条件: 状態遷移とトポロジ更新が EventStream に流れる_
- [x] 4.2 Gossip の送受信をドライバ経由で実行する
  - 送信対象を transport へ渡し、受信差分を取り込む
  - 送受信の順序が整合するように駆動する
  - _対応要件: 1.4_
  - _依存タスク: 3.1_
  - _完了条件: ドライバ経由で Gossip 交換が行われる_
- [x] 4.3 隔離イベントの同期を最優先で処理する
  - 隔離イベントを受け取り、隔離状態の同期が先に行われるようにする
  - 隔離解除時は明示解除の経路で再参加を許可する
  - _対応要件: 3.1, 3.2, 3.4_
  - _依存タスク: 2.4_
  - _完了条件: 隔離イベントが最優先で反映される_

- [x] 5. ClusterCore 反映とメトリクス連動を行う
  - _対応要件: 4.4, 4.5, 5.1, 5.3_
  - _依存タスク: 4.1_
- [x] 5.1 TopologyUpdated を ClusterCore に適用する
  - トポロジ更新を ClusterCore に反映し、失敗時は失敗イベントを発火する
  - 更新の重複は適切に無視できるようにする
  - _対応要件: 4.4, 4.5_
  - _依存タスク: 4.1_
  - _完了条件: トポロジ更新が ClusterCore に反映される_
- [x] 5.2 トポロジ更新に合わせてメトリクスを更新する
  - メンバー数などのメトリクスが更新されるようにする
  - 離脱/死亡メンバーの無効化が反映されるようにする
  - _対応要件: 5.1_
  - _依存タスク: 5.1_
  - _完了条件: メトリクスがトポロジ更新と同期する_
- [x] 5.3 メトリクス無効時の取得失敗を保証する
  - メトリクス収集が無効な場合は取得要求を失敗として返す
  - 無効状態のまま取得を継続しない
  - _対応要件: 5.3_
  - _依存タスク: 5.2_
  - _完了条件: メトリクス無効時の取得が失敗する_

- [x] 6. テストと検証を実施する
  - _対応要件: 1.1-5.5_
  - _依存タスク: 5.3_
- [x] 6.1 MembershipCoordinator のユニットテストを整備する
  - 未起動時の拒否、状態遷移、隔離期限、集約生成を検証する
  - 無効遷移の拒否と記録が正しいことを確認する
  - _対応要件: 1.1, 1.3, 2.1-2.5, 3.4, 4.2, 4.3_
  - _依存タスク: 2.4, 3.3_
  - _完了条件: Coordinator の主要ユースケースをテストで担保できる_
- [x] 6.2 EventStream と ClusterCore の統合テストを整備する
  - TopologyUpdated の反映と失敗イベントの発火を確認する
  - メトリクス更新と購読配信が同期することを確認する
  - _対応要件: 4.4, 4.5, 5.1, 5.2, 5.5_
  - _依存タスク: 5.3_
  - _完了条件: トポロジ更新とイベント連動が統合テストで確認できる_
- [x] 6.3 CI フルスイートで検証する
  - すべてのテストと lint を実行して通過させる
  - _対応要件: 全要件の最終検証_
  - _依存タスク: 6.1, 6.2_
  - _完了条件: `./scripts/ci-check.sh all` が成功する_
