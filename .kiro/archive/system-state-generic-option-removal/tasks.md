# 実装計画

- [x] 1. SystemStateGeneric を完全初期化済みへ移行
  - _対応要件: 1.1-1.6_
  - _依存タスク: -_
- [x] 1.1 未初期化表現（Option）を排除して必須フィールド化する
  - scheduler_context と tick driver runtime を「常に存在する状態」として扱えるようにする
  - remoting 設定の未設定/設定済みの状態を、二重保持ではなく一貫した状態で表現できるようにする
  - remote watch hook を未登録時も常に保持できるようにし、既定動作（Noop）を定義する
  - 既存の watch/unwatch フォールバック処理が動作する前提を維持する
  - _対応要件: 1.1, 1.2, 1.5_
  - _依存タスク: -_
  - _完了条件: SystemState の生成直後から scheduler/tick driver を参照でき、未初期化分岐が不要になる_

- [x] 1.2 remoting 設定の導出ロジックを確立し、整合性を保証する
  - remoting 無効時に remoting 設定参照が常に None になることを保証する
  - remoting 有効時に canonical host/port と quarantine duration が構成と一致することを保証する
  - canonical authority の部分設定（host のみ等）時の扱いが既存の検証ロジックと矛盾しないことを確認する
  - _対応要件: 1.3, 1.4_
  - _依存タスク: 1.1_
  - _完了条件: remoting の有無と参照結果が一貫し、既存の authority 検証が回帰しない_

- [x] 1.3 remote watch hook の転送/フォールバック意味論を固定し、回帰テストを追加する
  - hook 未登録時は watch/unwatch を転送せず、既存のフォールバック処理が必ず選択されることを保証する
  - hook 登録時は watch/unwatch を hook へ転送し、hook が消費した場合はフォールバック処理を実行しないことを保証する
  - hook 差し替え（最後に登録した hook が有効）の振る舞いが予期せぬ副作用を生まないことを確認する
  - _対応要件: 1.5, 1.6, 3.4_
  - _依存タスク: 1.1_
  - _完了条件: watch/unwatch の転送条件がテストで固定され、未登録/登録の両方で回帰がない_

- [x] 2. ActorSystem 構築フローの初期化順序を修正する
  - _対応要件: 2.1-2.4_
  - _依存タスク: 1.1_
- [x] 2.1 構成を入力に「依存物→SystemState→bootstrap」の順で起動できるようにする
  - scheduler context と tick driver runtime を先に用意し、それらを含む SystemState を一括生成できるようにする
  - SystemState 生成後に依存物を差し込むことを必須手順として要求しない起動経路に置き換える
  - 起動前に system 名・remoting・dispatcher 等の構成が SystemState に反映されることを保証する
  - _対応要件: 2.1, 2.2, 2.3_
  - _依存タスク: 1.1_
  - _完了条件: 起動経路から「生成後の差し込み」が消え、初期化順序が逆転しない_

- [x] 2.2 tick driver 構成不足時の fail-fast を維持し、診断可能性を担保する
  - tick driver 構成が欠落している場合に起動を拒否する条件を維持する
  - 失敗時に原因が追えるエラーメッセージ/分類になるように整える
  - 既存の利用者/テストが期待する失敗パス（起動前に落ちる）を崩さないことを確認する
  - _対応要件: 2.4_
  - _依存タスク: 2.1_
  - _完了条件: 構成不足での起動が確実に失敗し、テストで診断可能性が担保される_

- [x] 2.3 configure フェーズと root_started のタイミングを設計どおりに揃える
  - bootstrap 完了まで root_started が立たない起動フローの前提を満たす
  - 起動前フックで extra top-level 登録が可能であることをテストで固定する
  - 起動後は extra top-level 登録が拒否されることをテストで固定する
  - _対応要件: 2.3_
  - _依存タスク: 2.1_
  - _完了条件: configure での事前登録が安定し、起動後の登録禁止が維持される_

- [x] 3. Shared/公開 API の Option 排除と呼び出し側移行を行う
  - _対応要件: 1.2, 3.1-3.4_
  - _依存タスク: 2.1_
- [x] 3.1 Shared から scheduler/tick driver を Option なしで参照できるようにする
  - 共有所有権と「ロックガードを返さない」方針を維持したまま参照 API を整理する
  - tick driver snapshot / scheduler shutdown / remoting 参照の意味論が従来と一致することを確認する
  - 共有参照経路で panic を前提にしない（呼び出し側が安全に扱える）状態を維持する
  - _対応要件: 3.1, 3.2, 3.3_
  - _依存タスク: 2.1_
  - _完了条件: 共有ハンドル経由で Option 分岐なく参照でき、既存の補助 API が回帰しない_

- [x] 3.2 ActorSystem（core/typed/std）の参照 API を新しい意味論へ揃える
  - 呼び出し側が scheduler/tick driver の未初期化を気にしなくてよい API へ統一する
  - 既存の利用箇所から Option 分岐を除去し、コンパイルエラーを解消する
  - 参照 API の統一によって拡張実装（extensions/providers）が最小変更で移行できることを確認する
  - _対応要件: 1.2, 3.2_
  - _依存タスク: 3.1_
  - _完了条件: 主要 API の戻り値が一貫し、呼び出し側が未初期化分岐を持たない_

- [x] 4. `new_empty()` をテスト専用化し、既定 tick driver を提供する
  - _対応要件: 4.1-4.4_
  - _依存タスク: 3.2_
- [x] 4.1 `new_empty()` を `cfg(test)` / `feature = "test-support"` 専用 API として閉じ込める
  - 非テストビルドで `new_empty()` が公開 API として露出しないことを保証する
  - typed/std ラッパー側も同じ公開範囲へ揃える
  - テスト支援 feature を有効にした場合のみ利用できる状態を維持する
  - _対応要件: 4.1, 4.2_
  - _依存タスク: 3.2_
  - _完了条件: テスト以外のビルドでは `new_empty()` が利用できず、テストでは利用できる_

- [x] 4.2 `new_empty()` の既定構成（ManualTestDriver）で完全初期化済み状態を返す
  - ManualTestDriver を使う前提条件（runner API 有効）を満たす既定スケジューラ構成を用意する
  - remoting 無効の既定構成で、追加の初期化手順が不要であることを保証する
  - root_started をテスト都合の既定値として扱い、既存テストの前提を崩さないことを確認する
  - _対応要件: 4.3_
  - _依存タスク: 4.1_
  - _完了条件: `new_empty()` 直後に scheduler/tick driver が利用でき、追加の差し込みが不要になる_

- [x] 4.3 `new_empty()` 依存の既存テストを新しい前提へ移行する
  - 既存テストが期待する「最小構成」を、新しい既定構成に合わせて安定化させる
  - 必要に応じて「構成差分を持つテスト」は構成入力の起動経路に切り替える
  - テストが意図せず remoting や bootstrap 済み guardian を前提にしないことを確認する
  - _対応要件: 4.3_
  - _依存タスク: 4.2_
  - _完了条件: 既存テストが新しい `new_empty()` で安定して動作する_

- [x] 5. TickDriverRuntime の shutdown 契約を実装し、停止の安全性を保証する
  - _対応要件: 4.4_
  - _依存タスク: 2.1_
- [x] 5.1 shutdown が executor 停止を「必ず 1 回だけ」実行できるようにする
  - driver の停止に加えて、executor 停止コールバックが存在する場合の実行を保証する
  - clone された runtime が executor 停止責務を持たない前提を崩さない
  - shutdown の多重呼び出しでも安全に完了することを確認する
  - _対応要件: 4.4_
  - _依存タスク: 2.1_
  - _完了条件: shutdown の重複呼び出しでも executor 停止が 1 回に限定され、driver 停止が行われる_

- [x] 5.2 SystemState/ActorSystem の破棄で停止処理が実行されることをテストで固定する
  - 破棄経路で tick driver の停止が安全に実行されることを確認する
  - executor 停止コールバックが確実に実行されることを確認する
  - ManualTestDriver を含むテスト構成でも停止が安全であることを確認する
  - _対応要件: 4.4_
  - _依存タスク: 5.1_
  - _完了条件: drop 経路の停止がテストで担保され、リソースリークが発生しない_

- [x] 6. 回帰修正と品質ゲート（CI）を完了する
  - _対応要件: 5.1-5.3_
  - _依存タスク: 5.2_
- [x] 6.1 既存コード・テストの「直呼び差し込み」パターンを排除して移行を完了する
  - 「空の状態を作ってから差し込む」利用箇所を削除し、テスト用既定構成または構成入力の起動経路へ寄せる
  - コンパイルエラーと失敗テストを解消し、移行の着地点を統一する
  - 移行後の利用パターンが「依存物→SystemState→bootstrap」の前提に沿っていることを確認する
  - _対応要件: 1.1, 2.2, 3.2_
  - _依存タスク: 3.2, 4.2_
  - _完了条件: `SystemState::new()` + 後差し込み前提の利用が残らず、テストが移行完了している_

- [x] 6.2 回帰テストを実行し、変更範囲の安全性を確認する
  - 追加・更新したユニット/統合テストがすべてパスすることを確認する
  - core に `#[cfg(feature = "std")]` を追加していないことを確認する
  - lint を `allow` などで回避していないことを確認する
  - _対応要件: 5.2, 5.3_
  - _依存タスク: 6.1_
  - _完了条件: 変更範囲のテスト/チェックがパスし、禁止事項に抵触していない_

- [x] 6.3 `./scripts/ci-check.sh all` を通して品質ゲートを満たす
  - CI チェック（all）がエラー無しで完了することを確認する
  - 失敗した場合は最小の修正で原因箇所を特定し、差分を収束させる
  - no_std/std/lint を含む全チェックでの結果が安定していることを確認する
  - _対応要件: 5.1_
  - _依存タスク: 6.2_
  - _完了条件: `./scripts/ci-check.sh all` が成功する_
