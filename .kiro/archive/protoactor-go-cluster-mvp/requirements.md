# 要件ドキュメント

## 導入
protoactor-go 互換のクラスタ機能を MVP として Rust ランタイムに組み込み、ノード参加・リモートアドレッシング・メッセージ配信・障害隔離を最小構成で提供する。

## 要件

### 要件1: クラスタメンバーシップ管理（MUST）
**目的:** 運用者としてノードの参加・離脱を一元管理し、全ノードで一貫したメンバーシップビューを得たい。

#### 受け入れ条件
1. When ノードがクラスタ参加要求を送信したとき、Clusterサービスは ノードIDとauthorityの衝突を検証し、衝突がなければ状態を `Joining→Up` に遷移させて現在の全メンバーへ通知しなければならない。
2. When ノードが離脱通知を送信したとき、Clusterサービスは 対象ノードを `Leaving→Removed` としてマークし、離脱完了を全メンバーへ通知しなければならない。
3. While ハートビートが設定回数連続で欠落している間、Clusterサービスは 該当ノードを `Unreachable` として扱い、同じハートビート間隔以内に状態を全メンバーへ配信し続けなければならない。
4. If 同一authorityで異なるノードIDが検出された場合、Clusterサービスは 新規要求を拒否し、衝突イベントを EventStream に発火しなければならない。
5. The Clusterサービス shall 新規参加ノードに対し最新のメンバーシップテーブルをハンドシェイク時に送達しなければならない。

### 要件2: リモート PID 解決とアドレッシング
**目的:** 開発者としてリモートアクターを一貫した URI / PID で解決し、到達不能を即時に検知したい。

#### 受け入れ条件
1. When リモート PID が要求されたとき、Clusterサービスは メンバーシップと authority 情報から Canonical ActorPath を生成し、解決結果を返却しなければならない。
2. When 解決対象のノードが `Removed` または `Unreachable` のとき、Clusterサービスは 解決要求に到達不能ステータスを返し、送信を実行してはならない。
3. While authority が `Quarantine` 状態の間、Clusterサービスは 対象 authority への PID 解決と送信を拒否し続け、要求元へ隔離ステータスを返さなければならない。
4. If PID フォーマットが protoactor-go のスキームに合致しない場合、Clusterサービスは 解決を失敗として扱い、理由を含むエラーを返さなければならない。
5. The Clusterサービス shall 同一 PID への連続解決に対して順序を保持し、最新のメンバーシップバージョンに基づく結果のみを返さなければならない。

### 要件3: リモートメッセージ送達とバックプレッシャ（MUST）
**目的:** アプリケーションとしてリモート間メッセージを安全に送出し、接続状態に応じた配信保証とドロップポリシーを得たい。

#### 受け入れ条件
1. When authority が `Connected` のとき、Clusterサービスは 同一 PID 宛メッセージの送達順序を保持しなければならない。
2. While authority が `Disconnected` の間、Clusterサービスは 設定されたキュー上限までメッセージを遅延キューに積み、上限超過時は古いメッセージを DeadLetter として報告し続けなければならない。
3. If メッセージシリアライズに失敗した場合、Clusterサービスは 送信を中止し、エラーイベントを EventStream に発火しなければならない。
4. When authority が `Quarantine` に遷移したとき、Clusterサービスは 未送信メッセージをすべて拒否し、送信元へ隔離ステータスを返さなければならない。
5. The Clusterサービス shall 遅延キューに残るメッセージが再接続後に送出されたことを EventStream へ発火し、可観測性を提供しなければならない。

### 要件4: 障害検知とクォーランティン
**目的:** SRE として不正なアソシエーションや連続失敗を自動隔離し、手動／時間経過による復旧を制御したい。

#### 受け入れ条件
1. When InvalidAssociation が検出されたとき、Clusterサービスは 対象 authority を `Quarantine` に遷移させ、隔離理由を EventStream に発火しなければならない。
2. While authority が `Quarantine` 状態の間、Clusterサービスは 新規接続要求とメッセージ送信を拒否し続けなければならない。
3. If 隔離期間が設定期限を超過した場合、Clusterサービスは 自動的に `Disconnected` へ遷移させ、再接続試行を許可しなければならない。
4. When 運用者が手動解除コマンドを発行したとき、Clusterサービスは authority を即座に `Disconnected` に戻し、遅延キュー内メッセージを再送可能にしなければならない。
5. The Clusterサービス shall 隔離・解除・再接続の各イベントを監査ログまたは EventStream に記録しなければならない。

### 要件5: Virtual Actor（グレイン）アクティベーション（MUST）
**目的:** アプリケーション開発者として Virtual Actor をキー単位に自動アクティベートし、場所非依存でリクエストを一貫して処理させたい。

#### 受け入れ条件
1. When クラスタが Virtual Actor への最初のリクエストを受け取ったとき、Clusterサービスは キーに基づいてアクティベーション先ノードを決定し、該当ノードで Virtual Actor を自動生成しなければならない。
2. When 同一キーへの後続リクエストが到着したとき、Clusterサービスは 既存アクティベーションへルーティングし、アクティベーション再配置を行わない限り一貫した PID を返さなければならない。
3. While Virtual Actor がアイドル状態で設定時間を超過している間、Clusterサービスは アイドルタイムアウト後にアクティベーションをアンロードし、次回リクエスト時に再アクティベートし続けなければならない。
4. If アクティベーションノードが `Unreachable` または `Removed` になった場合、Clusterサービスは 再ルーティング先を決定し、状態を失わない範囲で Virtual Actor を再アクティベートしなければならない。
5. The Clusterサービス shall Virtual Actor のアクティベーション/デアクティベーション/再アクティベーションを EventStream へ記録し、監視者がキー単位で観測できるようにしなければならない。

### 要件6: Grain RPC とメッセージ定義（MUST）
**目的:** 開発者として Virtual Actor を RPC 形態で呼び出し、スキーマ互換なメッセージで型安全にやり取りしたい。

#### 受け入れ条件
1. When 開発者が Virtual Actor へ RPC 呼び出しを行うとき、Clusterサービスは リクエスト/レスポンスのスキーマ互換性を検証し、互換でなければエラーを返さなければならない。
2. When RPC 呼び出しがタイムアウトしたとき、Clusterサービスは タイムアウト理由と対象キーを含むエラーを返し、再試行ポリシーに従って再送または失敗を決定しなければならない。
3. While Virtual Actor がアクティブな間、Clusterサービスは 同一キーへの RPC を順序保持で処理し、並列度を設定上限以内に制御し続けなければならない。
4. If RPC メッセージのシリアライズ／デシリアライズに失敗した場合、Clusterサービスは 失敗を EventStream に記録し、当該呼び出しを完了せずに失敗させなければならない。
5. The Clusterサービス shall RPC 呼び出しのレイテンシ・成功/失敗率を観測指標として収集しなければならない。

### 要件7: Gossip とコンセンサス（MUST）
**目的:** 運用者としてクラスタ状態（メンバーシップ・ヘルス・ガーベジ情報）を低レイテンシで共有し、整合性を一定水準で担保したい。

#### 受け入れ条件
1. When メンバーシップが更新されたとき、Clusterサービスは Gossip により変更を全ノードへ拡散し、設定された収束時間以内に各ノードが最新ビューを保持しなければならない。
2. While ノード間でメンバーシップバージョンの差分が検出されている間、Clusterサービスは 差分を優先度付きで送信し続け、収束後に最新バージョンを確認しなければならない。
3. If ノードが自己のヘルスを `Unreachable` と判定した場合、Clusterサービスは コンセンサスルールに従って多数決またはシードノード判定を行い、決定した状態を全ノードへ伝播しなければならない。
4. When コンセンサスにより conflicting view が検出されたとき、Clusterサービスは ディザスタリカバリ手順（例: シードノード優先）に従って採用ビューを決定し、拒否されたビューを EventStream に記録しなければならない。
5. The Clusterサービス shall Gossip/コンセンサスの収束時間・失敗イベントを観測指標として収集し、設定値を調整できるようにしなければならない。

### 要件8: クイックスタートによるクラスタ体験
**目的:** 開発者としてクイックスタート手順だけでクラスタを形成し、クラスタ上のアクター機能を即座に試験できる状態にしたい。

#### 受け入れ条件
1. When 開発者がクイックスタート手順を実行したとき、Clusterサービスは 最低2ノードのクラスタを形成し、成功ステータスと参加ノード一覧を表示しなければならない。
2. When クイックスタート手順でサンプルアクターを spawn したとき、Clusterサービスは 生成された PID を返却し、リモートノード間でメッセージ送達できる状態にしなければならない。
3. While クイックスタートサンプルが実行中の間、Clusterサービスは ask/reply 形式の往復メッセージが両方向で成功することを保証するため、失敗時に理由を含むエラーを報告し続けなければならない。
4. If クイックスタート必須設定（authority/port/seedリスト）が欠落している場合、Clusterサービスは クラスタ形成を開始せず、欠落項目を明示した診断メッセージを出力しなければならない。
5. The Clusterサービス shall クイックスタートで使用した手順と設定例を単一ドキュメントで提供し、手順通りに実行した場合に再現可能でなければならない。

### 要件9: PubSub と配信パイプライン（SHOULD）
**目的:** アプリケーションとしてトピックベースの配信をクラスタ横断で利用し、遅延や分断時の動作を制御したい。

#### 受け入れ条件
1. When トピックが作成されたとき、Clusterサービスは 既存メンバーへトピック存在を配信し、購読要求を受け付け可能にしなければならない。
2. When メッセージがトピックへ発行されたとき、Clusterサービスは サブスクライバへ少なくとも1回届けるか、設定に応じて at-most-once/at-least-once を選択しなければならない。
3. While クラスタ分断が発生している間、Clusterサービスは 分断セグメント内での配信方針（遅延キューまたは即時ドロップ）を設定に従い適用し続けなければならない。
4. If トピックが存在しない、または購読者がゼロの場合、Clusterサービスは 発行を失敗として扱い、理由を返さなければならない。
5. The Clusterサービス shall PubSub 配信の遅延・ドロップ数・再送回数を観測指標として収集し、設定値を調整できるようにしなければならない。

### 要件10: 観測性と補助モジュール（SHOULD）
**目的:** SRE としてクラスタの状態・メッセージ経路・Virtual Actor/RPC/Gossip の挙動を計測し、ダッシュボードで可視化したい。

#### 受け入れ条件
1. When メンバーシップ/Quarantine/Gossip/Virtual Actor/RPC/DeadLetter イベントが発生したとき、Clusterサービスは EventStream とメトリクスエクスポータにイベント種別・対象キー/authority・結果を含めて送出しなければならない。
2. When RPC が完了したとき、Clusterサービスは レイテンシと成功可否をメトリクスとして記録し、しきい値超過時にアラートシグナルを発火しなければならない。
3. While クラスタが稼働している間、Clusterサービスは ダッシュボード雛形が参照するメトリクスエンドポイントを公開し続けなければならない。
4. If メトリクス収集が無効化されている場合、Clusterサービスは イベントのみを EventStream に送出し、メトリクス未収集であることを診断情報として返さなければならない。
5. The Clusterサービス shall 観測設定（サンプリング間隔・メトリクス種別・エクスポート先）を構成ファイルまたは API で変更可能にしなければならない。
