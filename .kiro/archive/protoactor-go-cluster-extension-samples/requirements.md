# 要件ドキュメント

## 導入
クラスタ拡張サンプル（`cluster_extension_no_std` / `cluster_extension_tokio`）を、ProtoActor-Go 並みのクラスタ挙動を再現する統合デモとして整備する。目的は、手動 `on_topology` 呼び出しやダミー実装に依存せず、Gossip/MemberList 由来のトポロジ更新から EventStream・メトリクス・実トランスポート連携までを最小手順で検証できること。

## 要件

### 要件1: 自動トポロジ伝搬を備えたサンプル起動
**目的:** 利用者として、サンプルを起動するだけで Gossip/MemberList からのトポロジ差分が自動反映され、手動 `on_topology` 呼びを不要にしたい。

#### 受け入れ条件
1. When サンプルノードがクラスタへ参加完了したとき、クラスタ拡張サンプルは Gossip/MemberList から受信したトポロジ差分を自動で ClusterCore に適用しなければならない。
2. If トポロジハッシュに変化がない場合、クラスタ拡張サンプルは EventStream へのトポロジ通知を発火してはならない。
3. When ノードが離脱したとき、クラスタ拡張サンプルは離脱ノードの PID キャッシュを削除し、差分を含むトポロジを EventStream に発火しなければならない。
4. While BlockList が取得できている間、クラスタ拡張サンプルはトポロジ通知に blocked 情報を含め続けなければならない。

### 要件2: Tokio TCP と結合した実動クラスタデモ
**目的:** 利用者として、TokioTcpTransport と接続した 2 ノード相当の join/leave を手順どおり実行し、クラスタイベントを観測したい。

#### 受け入れ条件
1. When サンプルの Tokio ノードを起動したとき、クラスタ拡張サンプルは TokioTcpTransport を介して seed/authority 情報を Gossip に渡し、join 成功イベントを EventStream に発火しなければならない。
2. When 2 ノード目が合流したとき、クラスタ拡張サンプルは両ノードの Kind 一覧と仮想アクター数を含むトポロジを自動配布しなければならない。
3. When いずれかのノードを停止したとき、クラスタ拡張サンプルは leave イベントを受信してメンバー数メトリクスを減算し、離脱を含むトポロジを EventStream に発火しなければならない。
4. If remoting 初期化または Gossip 起動が失敗した場合、クラスタ拡張サンプルは起動を中断し、理由を含む失敗イベントを EventStream に発火しなければならない。

### 要件3: ClusterProvider 連携によるトポロジ通知
**目的:** 利用者として、Provider 由来の起動・停止・トポロジ変化が拡張に自動橋渡しされることを確認したい。

#### 受け入れ条件
1. When ClusterProvider がクラスタ起動を完了したとき、クラスタ拡張サンプルは Provider からのコールバックを受け取り、ClusterCore の起動完了イベントを発火しなければならない。
2. When ClusterProvider がトポロジ更新を通知したとき、クラスタ拡張サンプルは更新内容を ClusterCore に転送し、差分に応じた EventStream トポロジイベントを発火しなければならない。
3. When ClusterProvider が停止を通知したとき、クラスタ拡張サンプルは Gossip/PubSub/IdentityLookup を停止シーケンス順に終了し、停止イベントを発火しなければならない。
4. If ClusterProvider 連携中にコールバック登録が失敗した場合、クラスタ拡張サンプルは起動を失敗として扱い、理由を含むエラーを返さなければならない。

### 要件4: Gossip/PubSub 連動とメッセージ配布の確認
**目的:** 利用者として、トポロジ配布と TopicKind 連動の PubSub が有効化され、イベント・メッセージ経路を最小コードで検証したい。

#### 受け入れ条件
1. When Gossip が起動したとき、クラスタ拡張サンプルは最新トポロジを定期的に配布し、購読者が受信できるようにしなければならない。
2. Where TopicKind が登録されている場合、クラスタ拡張サンプルは PubSub 起動後に Topic への購読を受け付けなければならない。
3. When 任意ノードから Topic へメッセージを発行したとき、クラスタ拡張サンプルは購読ノードにメッセージを配信し、受信イベントをログに出力しなければならない。
4. If PubSub または Gossip が起動に失敗した場合、クラスタ拡張サンプルはクラスタ起動を中断し、失敗理由を含むイベントを発火しなければならない。

### 要件5: 観測性・ドキュメント一貫性の確保
**目的:** 利用者として、メトリクス・イベント出力と実行手順ドキュメントがサンプル挙動と一致し、検証しやすい状態を保ちたい。

#### 受け入れ条件
1. When トポロジが更新されたとき、クラスタ拡張サンプルはメンバー数と仮想アクター数メトリクスを最新値に更新しなければならない。
2. While metrics が無効な構成の場合、クラスタ拡張サンプルはメトリクス取得要求に対して未収集であることを明示しなければならない。
3. When クラスタ拡張サンプルを起動・停止したとき、クラスタ拡張サンプルは EventStream に cluster 拡張イベント（起動/停止/失敗/トポロジ）を出力しなければならない。
4. When ドキュメント読者が `example.md` やサンプル冒頭コメントの手順に従ったとき、クラスタ拡張サンプルは記載どおりにビルド・実行でき、ログ例と整合する出力を得なければならない。
