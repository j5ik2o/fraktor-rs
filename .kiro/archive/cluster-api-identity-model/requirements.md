# 要件ドキュメント

## 導入
本仕様は、クラスタ向けの公開APIとIdentityモデルを定義し、仮想アクターを安定して参照・呼び出しできる基盤を整える。

## 要件

### 要件1: Identityモデル
**目的:** アプリ開発者として、仮想アクターを一意に識別できるIdentityモデルを利用し、参照の一貫性を保ちたい。

#### 受け入れ条件
1. Identityの作成が行われたとき、クラスタAPIは kind と identity を保持し、両者を取得可能でなければならない。
2. Identityのキー文字列が要求されたとき、クラスタAPIは `kind/identity` 形式で同一入力に対して同一文字列を返さなければならない。
3. kind または identity が空文字ならば、クラスタAPIはそのIdentityの作成または利用をエラーとして扱わなければならない。
4. クラスタAPIは常に kind と identity の一致によってIdentityの同一性を判定しなければならない。

### 要件2: Cluster API 取得と拡張登録
**目的:** システム統合者として、ActorSystem からクラスタAPIを確実に取得し、拡張として安全に利用したい。

#### 受け入れ条件
1. クラスタ拡張がインストールされたとき、ActorSystem はクラスタAPIのハンドルを取得可能でなければならない。
2. クラスタAPIが複数回要求されたとき、ActorSystem は同一のクラスタ拡張に紐づくハンドルを返さなければならない。
3. クラスタ拡張が未インストールならば、ActorSystem はクラスタAPIの取得要求を明確な失敗として返さなければならない。

### 要件3: Kind 登録と IdentityLookup 準備
**目的:** アプリ開発者として、クラスタのkindを登録し、IdentityLookupが正しく動作する状態を維持したい。

#### 受け入れ条件
1. メンバーモードのkind登録が行われたとき、クラスタAPIは登録済みkindをIdentityLookupに反映しなければならない。
2. クライアントモードのkind登録が行われたとき、クラスタAPIは登録済みkindをIdentityLookupに反映しなければならない。
3. 登録されていないkindでPID解決が要求されたとき、クラスタAPIは解決不能として失敗を返さなければならない。

### 要件4: PID解決 (Get)
**目的:** アプリ開発者として、IdentityからPIDを解決し、仮想アクターへアクセスしたい。

#### 受け入れ条件
1. 有効なIdentityのPID解決が要求されたとき、クラスタAPIはIdentityLookupを通じてPIDを返さなければならない。
2. IdentityLookupが解決不能を返したならば、クラスタAPIはPIDを返さずに失敗を返さなければならない。
3. クラスタが未起動の状態でPID解決が要求されたとき、クラスタAPIは明確な失敗を返さなければならない。

### 要件5: リクエスト API (Request/RequestFuture)
**目的:** アプリ開発者として、クラスタ経由で仮想アクターにメッセージを送信し、応答を受け取りたい。

#### 受け入れ条件
1. リクエストが発行されたとき、クラスタAPIはPIDを解決し、対象アクターへメッセージを送信しなければならない。
2. PID解決に失敗したならば、クラスタAPIはメッセージを送信せずに失敗を返さなければならない。
3. タイムアウトが指定されたとき、クラスタAPIはタイムアウト経過後に失敗を返さなければならない。
4. 非同期リクエストが要求されたとき、クラスタAPIは呼び出し側が結果を待機できるハンドルを返さなければならない。

### 要件6: no_std / std の整合性
**目的:** システム統合者として、no_std と std の両環境で同一のクラスタAPIを利用したい。

#### 受け入れ条件
1. core (no_std) が有効な環境でクラスタAPIが利用されたとき、クラスタAPIは同一の振る舞いで機能しなければならない。
2. std 機能が有効な環境でクラスタAPIが利用されたとき、クラスタAPIは no_std の機能を保持しつつ拡張可能でなければならない。
