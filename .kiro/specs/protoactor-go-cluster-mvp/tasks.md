# 実装計画

- [ ] 1. クラスタメンバーシップと Gossip 基盤を構築する
  - _(親タスクなので詳細は書かない)_
  - _対応要件: 1系, 7系_
  - _依存タスク: -_
- [ ] 1.1 参加・離脱・到達不能の状態遷移とハンドシェイクを実装する
  - Joining/Up/Leaving/Removed/Unreachable の状態機械をバージョン付きで適用し、衝突のない参加を全ノードへ通知する
  - 離脱完了とハートビート欠落による Unreachable 遷移をデフォルト間隔で反映し、最新テーブルを新規参加ノードへ送る
  - _対応要件: 1.1, 1.2, 1.3, 1.5_
  - _依存タスク: -_
- [ ] 1.2 Gossip 収束と矛盾解消を実装する
  - Diffusing/Reconciling/Confirmed の状態機械でデルタ拡散とレンジ再送を行い、シード優先の合意で収束させる
  - conflicting view 検出時に拒否ビューを EventStream/メトリクスへ記録し、再収束まで保守的に書き込みを抑制する
  - _対応要件: 7.1, 7.2, 7.3, 7.4_
  - _依存タスク: 1.1_

- [ ] 2. Authority 状態管理とバックプレッシャを実装する
  - _(親タスクなので詳細は書かない)_
  - _対応要件: 2系, 3系, 4系_
  - _依存タスク: 1.2_
- [ ] 2.1 PID 解決と authority ステータス連動を実装する
  - ResolveResult で Ready/Unreachable/Quarantine を返し、Removed/Unreachable/Quarantine への送信を拒否する
  - authority 衝突時に参加を拒否し、EventStream へ衝突イベントを発火する
  - _対応要件: 2.1, 2.2, 2.3, 2.4, 2.5, 4.2_
  - _依存タスク: 1.2_
- [ ] 2.2 遅延キューと順序保持付きバックプレッシャを実装する
  - Connected/Disconnected/Quarantine 状態で PID 単位の送信順序を維持し、キュー上限超過を DeadLetter + メトリクスで通知する
  - 再接続後に排出した件数を EventStream に記録し、シリアライズ失敗時は送信を中止してエラーイベントを発火する
  - _対応要件: 3.1, 3.2, 3.3, 3.4, 3.5_
  - _依存タスク: 2.1_
- [ ] 2.3 クォーランティン検知と自動解除を実装する
  - InvalidAssociation や連続失敗を検出して Quarantine に遷移し、隔離理由を EventStream/監査ログへ記録する
  - quarantine_deadline 経過や手動解除コマンドで Disconnected へ戻し、再接続を許可する
  - _対応要件: 4.1, 4.3, 4.4, 4.5_
  - _依存タスク: 2.2_

- [ ] 3. Virtual Actor（グレイン）アクティベーションを実装する
  - _(親タスクなので詳細は書かない)_
  - _対応要件: 5系, 2.5_
  - _依存タスク: 2.3_
- [ ] 3.1 グレインキーのルーティングと再配置を実装する
  - Rendezvous ハッシュで PartitionOwner を決定し、PidCache を連動させて一貫 PID を返す
  - owner が Unreachable/Removed の場合は再ルーティングし、必要なら再アクティベーションをトリガする
  - _対応要件: 5.1, 5.2, 5.4, 2.5_
  - _依存タスク: 2.3_
- [ ] 3.2 アイドル passivation と再アクティベーションを実装する
  - アイドル TTL 監視でグレインをアンロードし、次回リクエスト時に自動再アクティベートする
  - アクティベーション/デアクティベーション/再アクティベーションを EventStream へ記録する
  - _対応要件: 5.3, 5.5_
  - _依存タスク: 3.1_
- [ ] 3.3 スナップショットフックによる状態移送を実装する
  - ActivationRecord にオプションスナップショットを保持し、再配置先へ転送して適用する
  - スナップショット未提供の場合は stateless とみなし、必要な場合は隔離理由付きでエラー応答する
  - _対応要件: 5.4_
  - _依存タスク: 3.1_

- [ ] 4. Grain RPC 経路と制御を実装する
  - _(親タスクなので詳細は書かない)_
  - _対応要件: 6系_
  - _依存タスク: 3.3_
- [ ] 4.1 スキーマネゴシエーションと検証を実装する
  - ハンドシェイクで共通 schema_version を決定し、不一致時は接続を拒否して EventStream/メトリクスへ記録する
  - メッセージシリアライズ/デシリアライズ失敗を検出し、失敗理由付きで呼び出しを完了させる
  - _対応要件: 6.1, 6.4_
  - _依存タスク: 3.3_
- [ ] 4.2 RPC 並列度・順序・タイムアウトを制御する
  - GrainKey 単位で concurrency_limit と queue_depth を適用し、超過時のドロップ/拒否ポリシーを実装する
  - タイムアウトとリトライポリシーを適用し、結果にタイムアウト理由とキー情報を含める
  - _対応要件: 6.2, 6.3_
  - _依存タスク: 4.1_
- [ ] 4.3 RPC の観測指標を実装する
  - レイテンシと成功/失敗率をメトリクスとして収集し、閾値超過でアラートシグナルを発火する
  - EventStream に RPC 成功/失敗イベントを送出し、メトリクス無効時は診断を返す
  - _対応要件: 6.5, 10.2, 10.4_
  - _依存タスク: 4.2_

- [ ] 5. Quickstart 体験を提供する
  - _(親タスクなので詳細は書かない)_
  - _対応要件: 8系_
  - _依存タスク: 4.3_
- [ ] 5.1 Quickstart 構成検証とクラスタ起動を実装する
  - 必須設定（authority/port/seed）を検証し、2ノードクラスタを自動起動して参加一覧を表示する
  - 構成不足時は開始を拒否し、欠落項目を明示した診断を出力する
  - _対応要件: 8.1, 8.4_
  - _依存タスク: 4.3_
- [ ] 5.2 サンプルグレインのリモート往復を実装する
  - サンプルアクターを spawn し、リモート間で ask/reply が成功することを確認する
  - PID を出力し、失敗時は理由を含むエラーを報告する
  - _対応要件: 8.2, 8.3_
  - _依存タスク: 5.1_
- [ ] 5.3 Quickstart 実行結果のセルフヘルプ出力を実装する
  - 実行手順と設定例を単一出力として表示し、同手順実行で再現可能にする
  - 必要なコマンドと環境情報を成功ログとともに表示する
  - _対応要件: 8.5_
  - _依存タスク: 5.2_

- [ ] 6. PubSub 機能を実装する（SHOULD）
  - _(親タスクなので詳細は書かない)_
  - _対応要件: 9系_
  - _依存タスク: 5.3_
- [ ] 6.1 トピック作成と購読の拡散を実装する
  - トピック作成を全メンバーへ通知し、購読要求を受付可能にする
  - 存在しないトピックや購読ゼロ時は発行を失敗させ理由を返す
  - _対応要件: 9.1, 9.4_
  - _依存タスク: 6_
- [ ] 6.2 配信ポリシーと分断時挙動を実装する
  - at-most-once / at-least-once を設定に応じて切替え、少なくとも1回配送または即時ドロップを制御する
  - クラスタ分断中はセグメント内で遅延キューまたはドロップを設定に従い適用する
  - _対応要件: 9.2, 9.3_
  - _依存タスク: 6.1_
- [ ] 6.3 PubSub 観測指標を実装する
  - 配信遅延・ドロップ数・再送回数をメトリクスとして収集し、設定調整に利用できるようにする
  - _対応要件: 9.5, 10.1_
  - _依存タスク: 6.2_

- [ ] 7. 観測性とイベント出力を統合する
  - _(親タスクなので詳細は書かない)_
  - _対応要件: 10系, 3.5, 4.5_
  - _依存タスク: 6.3_
- [ ] 7.1 Cluster イベントの計測と配信を実装する
  - メンバーシップ/Quarantine/Gossip/Virtual Actor/RPC/DeadLetter/遅延キュー排出を EventStream とメトリクスに送出する
  - メトリクス無効時はイベントのみを送り、未収集である旨を診断情報として返す
  - _対応要件: 10.1, 10.4, 3.5, 4.5_
  - _依存タスク: 6.3_
- [ ] 7.2 メトリクスエンドポイントとダッシュボード雛形を公開する
  - 監視が参照するメトリクスエンドポイントを公開し、サンプリング間隔・種別・エクスポート先を設定可能にする
  - ダッシュボード雛形が要求するメトリクスを網羅し、閾値超過時のアラートシグナルを配信する
  - _対応要件: 10.2, 10.3, 10.5_
  - _依存タスク: 7.1_

- [ ] 8. テストと検証を実施する
  - _(親タスクなので詳細は書かない)_
  - _対応要件: 全要件_
  - _依存タスク: 7.2_
- [ ] 8.1 ユニットテストでコアロジックを検証する
  - Gossip 差分適用、Identity 解決、Virtual Actor passivation、RPC タイムアウトを単体検証する
  - Quarantine 遷移とバックプレッシャのドロップ動作を検証する
  - _対応要件: 1系, 2系, 3系, 4系, 5系, 6系, 7系_
  - _依存タスク: 7.2_
- [ ] 8.2 統合テストでクラスタ/Remoting シナリオを検証する
  - 2ノードで参加・離脱・Gossip 収束・リモート送達順序・隔離/解除をシナリオ検証する
  - Quickstart サンプルの往復成功と設定不足時の診断出力を確認する
  - _対応要件: 1系, 2系, 3系, 4系, 5系, 6系, 7系, 8系_
  - _依存タスク: 8.1_
- [ ] 8.3 負荷・回復テストでバックプレッシャと PubSub を検証する
  - 遅延キュー上限超過で DeadLetter とメトリクスが発火することを負荷シナリオで確認する
  - PubSub の at-most/at-least-once 配信と分断時ポリシーを検証する
  - _対応要件: 3系, 9系, 10系_
  - _依存タスク: 8.2_
