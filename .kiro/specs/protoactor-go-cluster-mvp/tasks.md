# 実装計画

- [ ] 1. クラスタメンバーシップと Gossip 基盤を用意する
  - _対応要件: 1系, 7系_
  - _依存タスク: -_

- [ ] 1.1 参加・離脱・到達不能の状態遷移とハンドシェイクを実装する
  - Joining/Leaving/Removed/Unreachable の状態機械をバージョン付きで適用し、衝突のない参加/離脱を全メンバーへ通知する
  - ハートビート欠落で Unreachable へ即時遷移させ、最新テーブルをハンドシェイクで新規ノードへ配布する
  - 同一 authority で異なる NodeId を検出したら参加を拒否し、理由付きイベントを EventStream に発火する
  - _対応要件: 1.1, 1.2, 1.3, 1.4, 1.5_
  - _依存タスク: -_
  - _完了条件: 参加/離脱/衝突/欠落ハートビートのシナリオがローカルテストで合格し、最新テーブル配布が確認できる_

- [ ] 1.2 Gossip 収束と矛盾解消を実装する
  - Diffusing/Reconciling/Confirmed のステートでデルタ拡散と欠損レンジ再送を行い、設定された収束時間内にビューを一致させる
  - シード優先で conflicting view を解消し、拒否ビューを EventStream/メトリクスに記録する
  - Gossip 収束時間と失敗イベントをメトリクスに収集し、調整に使えるようにする
  - _対応要件: 7.1, 7.2, 7.3, 7.4, 7.5_
  - _依存タスク: 1.1_
  - _完了条件: 複数ノードでデルタが設定収束時間内に一致し、矛盾検出時のイベント/メトリクスが取得できる_

- [ ] 2. Authority と送達パイプラインを制御する
  - _対応要件: 2系, 3系, 4系_
  - _依存タスク: 1.2_

- [ ] 2.1 PID 解決と authority ステータス判定を実装する
  - メンバーシップと authority から canonical ActorPath を生成し、最新バージョンに基づき Ready/Unreachable/Quarantine を返す
  - Removed/Unreachable/Quarantine への送信を拒否し、PID フォーマットが不正なときは理由付きエラーを返却する
  - authority 衝突や解決順序の乱れを検出して EventStream へ通知し、クライアントへ安定した解決結果を返す
  - _対応要件: 2.1, 2.2, 2.3, 2.4, 2.5_
  - _依存タスク: 1.2_
  - _完了条件: 正常/到達不能/隔離/衝突/不正 PID の解決結果がユニットテストで期待通りに返る_

- [ ] 2.2 遅延キューと順序保持を備えた送信経路を実装する
  - Connected 状態では PID 単位の送達順序を保持し、Disconnected 期間は上限付き遅延キューへ積む
  - 上限超過時は古いメッセージを DeadLetter として報告し、シリアライズ失敗やドロップを EventStream/メトリクスに記録する
  - 再接続後に遅延キューを排出し、排出件数を可観測性パイプラインへ送出する
  - _対応要件: 3.1, 3.2, 3.3, 3.4, 3.5_
  - _依存タスク: 2.1_
  - _完了条件: Connected/Disconnected/Quarantine 各状態で順序・バッファ・ドロップ挙動が統合テストで確認できる_

- [ ] 2.3 クォーランティン検知と解除フローを実装する
  - InvalidAssociation や連続失敗を隔離トリガとして検知し、隔離中は新規接続と送信を拒否する
  - quarantine_deadline 経過または手動解除で Disconnected へ戻し、遅延キューを再利用可能にする
  - 隔離・解除・再接続のイベントを理由付きで EventStream/監査ログ/メトリクスに送出する
  - _対応要件: 4.1, 4.2, 4.3, 4.4, 4.5_
  - _依存タスク: 2.2_
  - _完了条件: 隔離→自動解除→再接続のシナリオが再現でき、イベントと遅延キュー再利用が確認できる_

- [ ] 3. Virtual Actor をキー単位で運用する
  - _対応要件: 5系_
  - _依存タスク: 2.3_

- [ ] 3.1 グレインの割当てと PID キャッシュを整備する
  - Rendezvous ハッシュで PartitionOwner を決定し、PidCache の TTL/失効をメンバーシップや隔離状態と連動させる
  - 同一キーへの解決で一貫した PID を返し、owner が Unreachable/Removed のときは再ルーティングと再アクティベーションを行う
  - キャッシュ失効や再配置イベントを EventStream に記録してデバッグ可能にする
  - _対応要件: 5.1, 5.2, 5.4_
  - _依存タスク: 2.3_
  - _完了条件: 同一キーが継続して同一 PID を得ること、再配置時に新 PID へ迂回することがテストで確認できる_

- [ ] 3.2 アイドル passivation と再アクティベーションを実装する
  - キーごとのアイドル TTL を監視し、超過時にグレインをアンロードしてリソースを解放する
  - 次回リクエストで自動再アクティベートし、Activation/Deactivation/Reactivate を EventStream へ送出する
  - passivation が頻発する場合の設定調整ポイントをメトリクスかイベントで示し、運用者が判断できるようにする
  - _対応要件: 5.3, 5.5_
  - _依存タスク: 3.1_
  - _完了条件: アイドル timeout による passivation と再アクティベーションがテストで確認され、イベントが発火する_

- [ ] 3.3 グレイン状態移送フックを実装する
  - ActivationRecord にスナップショットとバージョンを保持し、再配置先へ転送・適用するフックを実装する
  - スナップショットが不要な場合は stateless とみなし、必要なのに欠落していれば隔離理由付きエラーを返す
  - 状態移送の成否と再アクティベーション結果を EventStream へ記録して観測可能にする
  - _対応要件: 5.4_
  - _依存タスク: 3.1_
  - _完了条件: スナップショット有無双方で再配置が成功し、欠落時は適切なエラーが返る_

- [ ] 4. Grain RPC 経路と制御を提供する
  - _対応要件: 6系_
  - _依存タスク: 3.3_

- [ ] 4.1 スキーマネゴシエーションとシリアライズ検証を実装する
  - ハンドシェイクで supported schema version を交換し、共通バージョンが無い場合は接続を拒否して診断を返す
  - シリアライズ/デシリアライズ失敗を検出し、理由付きで呼び出しを失敗させ EventStream/メトリクスに記録する
  - ネゴシエーションと失敗イベントをテスト用に観測できるフックを設け、再現性を担保する
  - _対応要件: 6.1, 6.4_
  - _依存タスク: 3.3_
  - _完了条件: スキーマ不一致・シリアライズ失敗を含む RPC 通信テストが期待通りに失敗/成功する_

- [ ] 4.2 RPC 並列度・タイムアウト・リトライを制御する
  - GrainKey 単位で concurrency_limit と queue_depth を適用し、超過時は drop/reject ポリシーで順序を維持したまま制御する
  - 呼び出しごとにタイムアウトとリトライポリシーを適用し、エラーにはキー情報と理由を必ず含める
  - 並列呼び出しと再試行の動作を可視化するメトリクス/ログを追加し、設定調整を容易にする
  - _対応要件: 6.2, 6.3_
  - _依存タスク: 4.1_
  - _完了条件: 並列度制御とタイムアウト/リトライ挙動がテストで確認され、順序保持が担保される_

- [ ] 4.3 RPC 観測指標を収集する
  - レイテンシと成功/失敗率をメトリクスとして記録し、閾値超過時にアラートシグナルを発火する
  - RPC 成功/失敗イベントを EventStream に送出し、メトリクス無効時は未収集である旨の診断を返す
  - 収集した指標をダッシュボード雛形に渡し、主要 KPI を可視化できる状態にする
  - _対応要件: 6.5, 10.2, 10.4_
  - _依存タスク: 4.2_
  - _完了条件: メトリクス収集/無効時の動作が確認でき、アラートシグナルが出力される_

- [ ] 5. Quickstart でクラスタ体験を提供する
  - _対応要件: 8系_
  - _依存タスク: 4.3_

- [ ] 5.1 Quickstart 設定検証とクラスタ起動を実装する
  - authority/port/seed の必須設定を検証し、欠落時は起動を拒否して欠落項目を明示する
  - デフォルトで2ノードをブートし、参加成功とメンバー一覧を表示する
  - 起動ログに環境情報と設定スナップショットを残し、再現可能性を高める
  - _対応要件: 8.1, 8.4_
  - _依存タスク: 4.3_
  - _完了条件: 必須設定欠落時に起動拒否と診断を出力し、正しい設定でクラスタ形成が成功する_

- [ ] 5.2 サンプルグレインのリモート往復を用意する
  - Quickstart 経由でサンプルアクター(グレイン)を生成し、ノード間 ask/reply を往復させる
  - 応答 PID と失敗理由をログ出力し、トラブルシュートを容易にする
  - 往復テストを自動化して Quickstart 体験の妥当性を継続検証する
  - _対応要件: 8.2, 8.3_
  - _依存タスク: 5.1_
  - _完了条件: サンプル往復テストが成功し、失敗時には理由が出力される_

- [ ] 5.3 Quickstart 手順と結果を一括出力する
  - 実行に使ったコマンドと設定例を単一ログ/ドキュメントとしてまとめ、手順通りに再現できる形にする
  - 成功サマリと環境ヒント（ポート/シード一覧/サンプル PID）を併記する
  - Quickstart 結果のクリーニング手順を含め、再実行時の衝突を防ぐ
  - _対応要件: 8.5_
  - _依存タスク: 5.2_
  - _完了条件: Quickstart の実行ログが再現可能な形で出力され、再実行手順も明示されている_

- [ ] 6. PubSub 配信をクラスタ対応で構築する（SHOULD）
  - _対応要件: 9系_
  - _依存タスク: 5.3_

- [ ] 6.1 トピック作成と購読拡散を実装する
  - トピック作成をクラスタへブロードキャストし、購読要求を受け付けられるようにする
  - 存在しないトピックや購読ゼロ時の publish を理由付きで失敗させる
  - 購読状態の変化を EventStream/メトリクスに送り、デバッグしやすくする
  - _対応要件: 9.1, 9.4_
  - _依存タスク: 5.3_
  - _完了条件: トピック作成/購読/未存在エラーがテストで確認できる_

- [ ] 6.2 配信ポリシーと分断時挙動を実装する
  - at-most-once / at-least-once をトピック設定で切替え、指定ポリシーで配信/ドロップを制御する
  - 分断発生中はセグメント内で遅延キューまたは即時ドロップを設定に従い適用する
  - ポリシー選択と分断時挙動をメトリクスやイベントで把握できるようにする
  - _対応要件: 9.2, 9.3_
  - _依存タスク: 6.1_
  - _完了条件: 配信ポリシーと分断時の遅延/ドロップ動作が統合テストで確認できる_

- [ ] 6.3 PubSub 観測指標を収集する
  - 配信遅延・ドロップ数・再送回数を計測し、ダッシュボードで参照できる形式に流す
  - 配信パイプラインのボトルネックを特定できるよう、トピック別のメトリクスを出力する
  - _対応要件: 9.5, 10.1_
  - _依存タスク: 6.2_
  - _完了条件: メトリクスが収集され、ダッシュボード雛形に必要な項目が揃う_

- [ ] 7. クラスタ観測性を統合する
  - _対応要件: 10系, 3.5, 4.5_
  - _依存タスク: 6.3_

- [ ] 7.1 イベント/メトリクスをクラスタ全体で配信する
  - メンバーシップ/Quarantine/Gossip/Virtual Actor/RPC/DeadLetter/遅延キュー排出のイベントを EventStream に集約する
  - メトリクス無効時もイベントを送り続け、無効である旨の診断を返す
  - 主要イベントにキーや authority、結果ステータスを添えてダッシュボード連携しやすくする
  - _対応要件: 10.1, 10.4, 3.5, 4.5_
  - _依存タスク: 6.3_
  - _完了条件: イベントとメトリクスが全カテゴリで送出され、メトリクス無効時のフォールバックが確認できる_

- [ ] 7.2 メトリクスエンドポイントとダッシュボード雛形を提供する
  - ダッシュボードが参照するメトリクスエンドポイントを公開し、サンプリング間隔・種別・エクスポート先を設定可能にする
  - 閾値超過時のアラートシグナルを配信し、雛形が要求する KPI がすべて埋まるようにする
  - メトリクス設定が動的に更新された場合の反映とエラーハンドリングを検証する
  - _対応要件: 10.2, 10.3, 10.5_
  - _依存タスク: 7.1_
  - _完了条件: エンドポイントと雛形が動作し、閾値超過アラートが確認できる_

- [ ] 8. テストと検証で品質を担保する
  - _対応要件: 全要件_
  - _依存タスク: 7.2_

- [ ] 8.1 コア機能のユニットテストを作成する
  - Gossip 差分適用、Identity 解決、Virtual Actor passivation/reactivation、RPC タイムアウトを単体で検証する
  - 隔離遷移とバックプレッシャのドロップポリシーを個別シナリオで確認する
  - テーブルやキャッシュが no_std 前提で動くことを確認するユニットを追加する
  - _対応要件: 1系, 2系, 3系, 4系, 5系, 6系, 7系_
  - _依存タスク: 7.2_
  - _完了条件: 各ユニットテストがローカルでグリーンになり、失敗時に原因が明確になる_

- [ ] 8.2 クラスタ統合テストを実施する
  - 2ノードで参加/離脱/Gossip 収束/リモート送達順序/隔離と解除を通し、Quickstart 成功と設定不足時診断を確認する
  - Virtual Actor のルーティング、RPC 経路、メンバーシップ更新を跨いだシナリオを再現する
  - 収束時間やレイテンシなど主要メトリクスが期待値内に収まるかを検証する
  - _対応要件: 1系, 2系, 3系, 4系, 5系, 6系, 7系, 8系_
  - _依存タスク: 8.1_
  - _完了条件: 統合テストが安定して通過し、必須シナリオのログが取得できる_

- [ ] 8.3 負荷・回復テストを行う
  - 遅延キュー上限を超える負荷で DeadLetter とメトリクス発火を確認し、再接続後の排出と回復を測定する
  - PubSub の at-most/at-least-once 配信と分断時ポリシーを高負荷で検証し、観測値をダッシュボードに反映する
  - Virtual Actor の再配置や RPC タイムアウトを混ぜたストレスシナリオで安定性を確認する
  - _対応要件: 3系, 9系, 10系_
  - _依存タスク: 8.2_
  - _完了条件: 負荷シナリオで期待どおりのドロップ/再送/観測値が得られ、リカバリ挙動が確認できる_
