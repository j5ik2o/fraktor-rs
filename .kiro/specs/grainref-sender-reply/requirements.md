# 要件ドキュメント

## 導入
本仕様は GrainRef に送信者を明示できる API を追加し、Grain からの返信が送信アクターへ確実に届く経路を提供する。

## 要件

### 1. 送信者指定API
**目的:** ランタイム利用者として送信アクターを指定して Grain に送信し、返信の宛先を制御してアクター間通信と整合させたい。

補足: 本要件での送信者（sender）はユーザが用意したアクター参照を指す。内部的に生成される temp reply actor は送信者未指定時の仕組みであり、送信者指定APIの対象には含めない。

#### 受け入れ条件
1. 送信者を指定して送信する要求が起きたとき、GrainRef は指定された送信者を sender としてメッセージを送信しなければならない
2. 送信者を指定して要求を送信したとき、GrainRef は成功と失敗を Result で判別できる Ask 応答ハンドルを返さなければならない
3. 送信者指定APIが利用されたとき、GrainRef は既存の呼び出しと同等の解決・送信手順を適用しなければならない
4. 送信者指定APIが利用されたとき、GrainRef は既存の呼び出しと同等のオプション（タイムアウト、リトライ等）の意味を保たなければならない
5. 送信者指定の要求で返信が発生したとき、Ask 応答ハンドルの future は送信者へ配送された返信と同じ内容を Result の成功として完了しなければならない
6. 送信者指定の要求で失敗が発生したとき、Ask 応答ハンドルの future は失敗理由を Result の失敗として完了しなければならない

### 2. 返信経路の整合性
**目的:** ランタイム利用者として Grain が sender に返信する前提を崩さず、送信者の種類に依存しない返信経路を得たい。

#### 受け入れ条件
1. Grain が sender に返信したとき、ランタイムは返信を指定された送信アクターへ配送しなければならない
2. 送信者が指定されない要求が起きたとき、GrainRef は従来の返信待機の振る舞いを維持しなければならない
3. 同一の Grain に対する送信者指定と未指定の要求が混在したとき、ランタイムは各要求の返信先を取り違えてはならない

### 3. 失敗時のふるまい
**目的:** ランタイム利用者として送信失敗や解決失敗を観測可能な形で受け取り、回復判断を行いたい。

#### 受け入れ条件
1. Grain 解決に失敗したならば、GrainRef は呼び出し元へエラーを返さなければならない
2. 送信者指定APIで送信に失敗したならば、GrainRef は送信失敗としてエラーを返さなければならない
3. 送信失敗または解決失敗が起きたとき、クラスタモジュールは失敗イベントの通知を行わなければならない

### 4. 利用例
**目的:** ランタイム利用者として送信者指定 API の利用手順を把握し、既存のコードを安全に更新したい。

#### 受け入れ条件
1. サンプルコードを提供する場合、サンプルは送信アクターを指定した呼び出しと返信の流れを示さなければならない
2. 既存の利用例を更新する場合、更新後の例は送信者指定 API を使った返信経路を示さなければならない
