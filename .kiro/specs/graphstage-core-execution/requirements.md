# 要件ドキュメント

## 導入
本ドキュメントは、fraktor-streams の実行系を GraphStage 中心に再設計するための要件を定義する。現状の実行経路を GraphStage に統合し、Pekko 互換の拡張に耐える基盤を提供することを目的とする。

## 要件

### 1. GraphStage を中心とした実行統一
**目的:** 開発者として GraphStage を唯一の実行抽象として利用し、拡張性と互換性を確保したい。

#### 受け入れ条件
1. ストリームがマテリアライズされたとき、ストリーム実行系は各ステージの GraphStageLogic を生成しなければならない。
2. Source/Flow/Sink が作成されたとき、ストリーム実行系は GraphStage の定義に基づいてストリームグラフを構築しなければならない。
3. ストリームが実行中の間、ストリーム実行系はステージの振る舞いを GraphStageLogic のフックだけで決定し続けなければならない。
4. 無効な GraphStage 定義が含まれるならば、ストリーム実行系はマテリアライズを失敗として扱わなければならない。

### 2. ステージライフサイクルの一貫性
**目的:** 開発者としてステージの開始・完了・失敗を一貫して扱い、予測可能な実行フローを得たい。

#### 受け入れ条件
1. ストリームが開始されたとき、ストリーム実行系は各ステージの開始フックを一度だけ呼び出さなければならない。
2. 上流が完了したとき、ストリーム実行系は下流へ完了を伝播し、該当ステージの完了フックを呼び出さなければならない。
3. 処理中にエラーが発生したとき、ストリーム実行系は該当ステージのエラーフックを呼び出し、ストリームを失敗状態に遷移させなければならない。
4. キャンセルが要求されたとき、ストリーム実行系はステージを終了状態へ移行させなければならない。

### 3. 需要駆動とバックプレッシャ
**目的:** 開発者として需要に基づく処理制御を行い、過剰送出や取りこぼしを防ぎたい。

#### 受け入れ条件
1. 下流から需要が通知されたとき、ストリーム実行系は該当ステージの on_pull を通知しなければならない。
2. 上流から要素が到着したとき、ストリーム実行系は該当ステージの on_push を通知しなければならない。
3. 需要が残っていない間、ストリーム実行系は下流へ新しい要素を送出し続けてはならない。
4. 需要を超える送出が発生しようとしたならば、ストリーム実行系は送出を抑止しなければならない。

### 4. 外部イベント連携の基盤
**目的:** 開発者として外部駆動（ActorRef 等）をストリームへ安全に取り込める基盤を確保したい。

#### 受け入れ条件
1. 外部イベントがステージに通知されたとき、ストリーム実行系は該当ステージの処理を再駆動しなければならない。
2. 外部イベントがストリームの停止後に発生したならば、ストリーム実行系はそのイベントを無視しなければならない。
3. 外部イベントが発生しても処理に影響しない場合、ストリーム実行系はストリーム状態を変更し続けてはならない。
