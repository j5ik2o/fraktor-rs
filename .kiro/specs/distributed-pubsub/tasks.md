# 実装計画

- [x] 1. コア契約と既定値の整備
- [x] 1.1 PubSub ドメイン型・配送契約・既定値を整備する
  - PubSub のトピック/オプション/バッチ/配送レポート/自動応答バッチの契約を定義する
  - PublishOptions の上書きルールとシステム既定値を明確に適用できる状態にする
  - 配送境界は core のトレイトとして整理し、no_std で利用可能にする
  - _Requirements: 2.1, 2.2, 2.3, 3.4, 6.1, 6.2_
- [x] 1.2 PubSub 設定の伝播を前提にする
  - PubSub のタイムアウト/TTL などの設定を上位設定から受け取れる状態にする
  - no_std/std の両環境で同一設定が適用される前提を整える
  - _Requirements: 6.1, 6.2_

- [x] 2. 購読状態とトピック既定値の管理
- [x] 2.1 購読状態とトピック既定値を一貫して管理する
  - 購読追加/解除の制約を満たし、未購読への送達を防止する
  - 購読状態は単一の状態集合から導出できるよう整理する
  - トピック既定値を保持し publish 時に参照する
  - _Requirements: 1.1, 1.2, 1.5, 3.4_
- [x] 2.2 購読変更と送達対象なしを観測できるようにする
  - 購読追加/削除の観測イベントを発行する
  - 送達対象なしを検知し観測できる状態にする
  - メトリクスのスナップショットを発行できるようにする
  - _Requirements: 1.4, 5.4, 5.5_

- [ ] 3. トピック配送ルーティング
- [ ] 3.1 トピック配送の基本ルーティングを実装する
  - ノード単位に購読者を束ねて配送する
  - ローカル購読者への配送を継続できるようにする
  - _Requirements: 1.3, 1.5, 2.4, 4.4_
- [ ] 3.2 トポロジ変化に追従する
  - トポロジ更新で到達不能ノードを除外する
  - 再参加ノードの購読を再評価する
  - 配送失敗を分類し、停止/再評価の判断に反映する
  - _Requirements: 4.1, 4.2, 4.3, 5.2, 5.3_

- [x] 4. 公開フローとバッチ制御
- [x] 4.1 公開フローと受理/拒否の結果を返す
  - 受理/拒否の結果を返し、拒否理由を明示する
  - 受理時に配送開始できる状態を作る
  - シリアライズ可否を判定し、不可なら拒否する
  - _Requirements: 2.1, 2.2, 2.3, 3.1, 3.2, 3.3, 3.4_
- [x] 4.2 バッチ条件とキュー制御を実装する
  - バッチ上限到達時に即時配送できるようにする
  - 待機時間満了でバッチ配送できるようにする
  - キュー上限時は適切に拒否する
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 3.1_

- [x] 5. 配送エンドポイント実装
- [x] 5.1 no_std の最小配送を提供する
  - ローカル配送のみを行う最小実装を提供する
  - 配送結果をレポートできるようにする
  - _Requirements: 2.4, 4.4, 6.1_
- [x] 5.2 std の配送実装でリモート送達を可能にする
  - タイムアウトを用いて失敗を分類する
  - 失敗レポートをトピック側へ返す
  - _Requirements: 2.1, 2.2, 2.3, 4.2, 5.2, 5.3, 6.2_

- [x] 6. クラスタ統合と観測イベント
- [x] 6.1 クラスタ拡張のライフサイクルへ統合する
  - 起動/停止と PubSub 設定の伝播を行う
  - トポロジ更新を配送層へ橋渡しする
  - _Requirements: 1.1, 1.2, 1.3, 4.1, 6.1, 6.2_
- [x] 6.2 公開/配送/購読/メトリクスの観測イベントを発行する
  - 公開受理/拒否と配送成功/失敗を観測できるようにする
  - 購読の追加/削除を観測できるようにする
  - メトリクスを観測できるようにする
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5, 1.4_

- [ ] 7. テスト
- [x] 7.1 単体テストで主要ロジックを検証する
  - 購読管理と送達拒否理由を検証する
  - 公開結果とバッチ条件の挙動を検証する
  - _Requirements: 1.1, 1.2, 1.5, 2.1, 2.2, 2.3, 2.4, 3.1, 3.2, 3.3, 3.4_
- [ ] 7.2 統合テストでクラスタ追従と配送を検証する
  - トポロジ追従と再評価の挙動を検証する
  - 観測イベントとメトリクスの発火を検証する
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 5.1, 5.2, 5.3, 5.4, 5.5, 6.1, 6.2_
