# 実装計画

- [x] 1. 互換MUSTの公開契約と入力検証の基盤を固める
- [x] 1.1 互換MUST演算子の公開契約カタログを確立する
  - 利用者が演算子可否・終端条件・失敗条件を一貫して参照できるようにする。
  - 互換対象の範囲を機械可読な形で保持し、実行時判定と検証で共用する。
  - _Requirements: 1.1, 1.3, 1.4_

- [x] 1.2 無効引数を構築時に失敗させる検証モデルを導入する
  - 無効な並列度・バッファ容量・上限値を実行開始前に拒否する。
  - エラー理由を呼び出し側が識別できる形で返す。
  - _Requirements: 1.2_

- [x] 1.3 互換範囲と診断情報を外部へ提示できる状態にする
  - 対応済み/未対応の境界を同一フォーマットで出力する。
  - 不一致診断が後続検証と同じ語彙で読めるように整える。
  - _Requirements: 1.4, 8.3_

- [x] 2. Substream の意味論を Pekko 互換で再現する
- [x] 2.1 (P) Substream の公開操作を無制限マージ・制限付きマージ・連結に分離する
  - 分岐統合の選択肢を意味論ごとに分離し、選択時点で意図が確定するようにする。
  - 互換MUSTで求める既定挙動を明文化して適用する。
  - _Requirements: 1.1, 2.5_

- [x] 2.2 `group_by` のキー別分岐と上限超過失敗を実装する
  - 新規キー到達時に専用サブストリームを生成して振り分ける。
  - キー数上限を超えた時点で一貫した失敗へ遷移させる。
  - _Requirements: 2.1, 2.2_

- [x] 2.3 `split_when` と `split_after` の境界挙動を厳密化する
  - 真になった要素が「次サブストリーム先頭」か「現サブストリーム末尾」かを規約通りに分ける。
  - 分割規約が後続統合時にも崩れないよう状態遷移を統一する。
  - _Requirements: 2.3, 2.4_

- [x] 2.4 substream 間の下流圧力伝播と統合完了整合を実装する
  - いずれかのサブストリームが圧力を出した場合に上流へ伝播する。
  - 完了済みサブストリームの要素欠落を防いで統合終端する。
  - _Requirements: 2.5, 2.6_

- [x] 3. flatMap 系の順序性と並行性を確立する
- [x] 3.1 (P) `flat_map_concat` の逐次消費契約を実装する
  - 前の内側ストリーム完了前に次を開始しない制御を固定する。
  - 逐次処理中の下流需要と上流要求の整合を保つ。
  - _Requirements: 3.1_

- [x] 3.2 `flat_map_merge` の同時実行上限と上流抑止を実装する
  - 同時実行上限到達時に新規生成要求を抑止する。
  - 上限解除後に再開できるよう待機制御を安定化する。
  - _Requirements: 3.2_

- [x] 3.3 内側ストリーム順序保持と失敗時全体終端を実装する
  - 同一内側ストリーム内の順序を保持して下流へ渡す。
  - 回復なし設定では内側失敗を全体失敗へ昇格する。
  - _Requirements: 3.3, 3.4_

- [x] 4. Dynamic Hub の接続・配信契約を固める
- [x] 4.1 (P) MergeHub の受信側先行有効化と全 producer への圧力伝播を実装する
  - 受信側が有効化されるまで送信側接続を受け付けない。
  - consumer が追従できない場合に全 producer へ圧力を返す。
  - _Requirements: 4.1, 4.2_

- [x] 4.2 (P) BroadcastHub の購読者不在圧力と遅延参加購読を実装する
  - 購読者不在時に要素をドロップせず圧力で制御する。
  - 新規購読者は接続後到着要素を受信できるようにする。
  - _Requirements: 4.2, 4.3_

- [x] 4.3 (P) PartitionHub の単一割当と不在時圧力契約を実装する
  - 1要素を必ず1つの有効購読者へ割り当てる。
  - 購読者不在時は規約に従って上流へ圧力を返す。
  - _Requirements: 4.4, 4.5_

- [x] 5. KillSwitch の停止制御を確立する
- [x] 5.1 (P) 初回制御優先の `shutdown` / `abort` 契約を実装する
  - `shutdown` で上流取消しと下流完了を行う。
  - `abort` で上流取消しと下流失敗を行い、後続制御は無視する。
  - _Requirements: 5.1, 5.2, 5.3_

- [x] 5.2 (P) 共有制御点による複数ストリーム同時制御を実装する
  - 実行開始前に共有制御点を生成し、複数ストリームへ適用できるようにする。
  - 未発火中は通常処理が継続することを保証する。
  - _Requirements: 5.4, 5.5_

- [x] 6. Restart/Backoff/Supervision の中核契約を実装する
- [x] 6.1 (P) fail/complete 起因再起動とバックオフ待機中圧力を実装する
  - 失敗/完了の両方で再起動判定を行う。
  - 待機中は発行停止し、上流へ圧力を返し続ける。
  - _Requirements: 6.1, 6.2_

- [x] 6.2 再起動上限到達時の終端を互換MUST既定で固定する
  - 上限到達時の終端アクションを契約として明示する。
  - 互換MUSTプロファイルでは既定終端を完了で固定する。
  - _Requirements: 6.3_

- [x] 6.3 supervision 判定と split 特則を実装する
  - resume/restart/stop を決定する判定器を導入する。
  - split 系で restart を resume 同等として扱う。
  - _Requirements: 6.4, 6.5, 6.6_

- [x] 7. 非同期境界と融合実行の契約を再構築する
- [x] 7.1 (P) 境界なし融合実行と境界あり実行分離を実装する
  - 境界未挿入時は融合実行として扱う。
  - 境界挿入時は独立実行区間へ分離する。
  - _Requirements: 7.1, 7.2_

- [x] 7.2 境界バッファの順序保持と飽和時圧力返却を実装する
  - 境界を跨いでも区間内順序が保持されるようにする。
  - バッファ飽和時に上流へ圧力を返す。
  - _Requirements: 7.3, 7.4_

- [x] 8. 互換性検証スイートを実装し CI に接続する
- [x] 8.1 要件ID単位で観測結果を判定する検証シナリオ群を実装する
  - 各シナリオで `emits / backpressures / completes / fails` を判定可能にする。
  - 受け入れ条件を再現可能な最小ケースへ分解して維持する。
  - _Requirements: 8.1, 8.4_

- [x] 8.2 不一致箇所を識別可能な診断出力を実装する
  - 期待値と実測値の差分を要件ID単位で記録する。
  - 失敗原因を再現手順と結び付けて出力する。
  - _Requirements: 8.3_

- [x] 8.3 core no_std 検証とフルCIゲートを接続する
  - no_std ビルド検証を継続的に実行できる状態にする。
  - 互換検証結果とフルCI結果を統合し、通過を必須化する。
  - _Requirements: 8.2, 9.2_

- [x] 9. 破壊的変更許容ポリシーを運用可能にする
- [x] 9.1 互換MUST達成に不要な旧挙動維持コードを除去する
  - 仕様準拠に不要な互換維持分岐を削除する。
  - 削除後の振る舞いを互換検証で再確認する。
  - _Requirements: 9.1, 9.3_

- [x] 9.2 仕様準拠優先の判定ルールを実装プロセスへ組み込む
  - 仕様準拠とコード簡潔性を優先する判定を継続適用する。
  - 変更はテストとCI通過を満たしたものだけを採用する。
  - _Requirements: 9.2, 9.4_

- [x] 10. 統合回帰で最終受け入れ条件を確認する
- [x] 10.1 演算子横断の統合シナリオで主要失敗モードを検証する
  - substream・flatMap・Hub・KillSwitch・Restart・async 境界の組み合わせを検証する。
  - 終端条件と圧力伝播の競合ケースを先に潰す。
  - _Requirements: 2.6, 3.4, 4.5, 5.3, 6.3, 7.4_

- [x] 10.2 最終トレース確認とフルCI通過を完了する
  - 要件IDと検証結果の対応を最終確認する。
  - 全体CI通過をもって実装準備完了とする。
  - _Requirements: 8.4, 9.2_

- [x] 11. 検証指摘の是正と設計整合を完了する
- [x] 11.1 公開API移行契約を実装実態に合わせて更新する
  - 設計の公開API契約を Source/Flow の実装シグネチャと一致させる。
  - `SubFlow` 前提ではなく、現行の `Tuple/Vec` サーフェスで互換MUST範囲を明示する。
  - _Requirements: 1.1, 2.5, 9.4_

- [x] 11.2 要件IDトレーサビリティを `1.1`〜`9.4` まで欠落なく整備する
  - 要件IDごとの検証エビデンス行列をテストとして保持する。
  - 追跡可能性を機械的に確認できる検証を追加する。
  - _Requirements: 8.1, 8.4, 9.2_

- [x] 11.3 Verification コンポーネントの配置規約を設計へ反映する
  - `CompatSuite` / `CiGate` / `MigrationPolicyGuard` を tests 側コンポーネントとして明記する。
  - 実装配置と設計記述の乖離を解消する。
  - _Requirements: 8.2, 9.2_

- [x] 12. Pekko MUST ギャップを追加是正する
- [x] 12.1 Substream 公開APIを `SubFlow` 経由へ移行する
  - `group_by` / `split_when` / `split_after` の戻り型を `Tuple/Vec` 露出から `SubFlow` 系へ移行する。
  - `merge_substreams` / `merge_substreams_with_parallelism` / `concat_substreams` は `SubFlow` 側で統合操作として提供する。
  - _Requirements: 1.1, 2.1, 2.3, 2.4, 2.5_

- [x] 12.2 `async_boundary` を非パススルー化する
  - 境界内部バッファを導入し、入力受理と出力排出を分離する。
  - 境界バッファ飽和時に上流へ backpressure を返す契約を明示する。
  - _Requirements: 7.2, 7.3, 7.4_

- [x] 12.3 Restart 設定軸を拡張する
  - `min/max backoff`・`random factor`・`max restarts within`・終端アクションを設定可能にする。
  - 互換MUST既定（上限到達時 Complete）を保持しつつ、将来拡張点を型で固定する。
  - _Requirements: 6.1, 6.2, 6.3, 9.4_

- [x] 12.4 互換演算子カタログを MUST 範囲で拡張する
  - 既存9演算子に加えて、MUST対象の公開演算子を契約カタログへ追加する。
  - 対応範囲の識別情報（coverage）を要件IDと機械的に紐付ける。
  - _Requirements: 1.1, 1.3, 1.4, 8.1_

- [x] 12.5 互換検証を実行観測ベースへ強化する
  - 期待値と実測値の比較を、実ランタイムの `emits/backpressures/completes/fails` 観測で判定する。
  - 要件トレーサビリティの検証関数を表面チェック中心から挙動確認中心へ寄せる。
  - _Requirements: 8.1, 8.3, 8.4_
