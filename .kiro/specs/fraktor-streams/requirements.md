# 要件ドキュメント

## 導入
fraktor-streams は fraktor-rs にストリーム処理の基盤を追加し、no_std のコアと std の拡張を分離した形で提供する。Pekko Streams 相当の概念（Source/Flow/Sink と Materializer）を最小限の API として定義し、バックプレッシャ・エラー伝播・完了通知を一貫したルールで扱えることを目的とする。

## 要件

### 1. コアストリーム API
**目的:** ランタイム利用者として Source/Flow/Sink を組み合わせたストリーム処理を記述し、型安全にデータを流したい。

#### 受け入れ条件
- 1.1 ストリーム構成要素が定義されたとき、fraktor-streams は Source/Flow/Sink の組み合わせを型安全に表現しなければならない
- 1.2 無効な接続（入力/出力型が一致しない）ならば、fraktor-streams はコンパイル時に不成立としなければならない
- 1.3 ストリームが構成されている間、fraktor-streams は構成要素間の接続関係を保持し続けなければならない

### 2. グラフ合成とマテリアライズ値
**目的:** ランタイム利用者として複数のストリームを合成し、マテリアライズ結果を一貫した規則で取得したい。

#### 受け入れ条件
- 2.1 複数のストリームが合成されたとき、fraktor-streams は合成後のグラフを単一の実行単位として扱わなければならない
- 2.2 ストリームがマテリアライズされたとき、fraktor-streams は合成規則に基づいてマテリアライズ値を返さなければならない
- 2.3 合成規則が定義されている間、fraktor-streams は同一の構成に対して同一のマテリアライズ結果を返し続けなければならない

### 3. Materializer のライフサイクル
**目的:** ランタイム利用者として Materializer を通じてストリーム実行を開始・停止し、実行中の状態を制御したい。

#### 受け入れ条件
- 3.1 Materializer が起動されたとき、fraktor-streams はストリーム実行を開始できるようにしなければならない
- 3.2 Materializer の停止が要求されたとき、fraktor-streams は実行中のストリームを停止できるようにしなければならない
- 3.3 Materializer が有効である間、fraktor-streams はストリームの実行状態を一貫したルールで管理し続けなければならない

### 4. バックプレッシャと需要制御
**目的:** ランタイム利用者として上流と下流の速度差を吸収し、過負荷やメモリ過剰使用を防ぎたい。

#### 受け入れ条件
- 4.1 下流が需要を出したとき、fraktor-streams は上流へ需要情報を伝播しなければならない
- 4.2 下流が需要を出していないならば、fraktor-streams は上流からのデータ生成を抑止しなければならない
- 4.3 バックプレッシャが有効な間、fraktor-streams は過剰なバッファ消費を抑制し続けなければならない

### 5. 完了・キャンセル・エラー伝播
**目的:** ランタイム利用者としてストリームの完了や失敗を明確に把握し、復旧や停止の判断を行いたい。

#### 受け入れ条件
- 5.1 ストリームが正常完了したとき、fraktor-streams は完了を下流に通知しなければならない
- 5.2 失敗が発生したならば、fraktor-streams は失敗を下流に伝播しなければならない
- 5.3 キャンセルが要求されたとき、fraktor-streams は上流へのキャンセル伝播を開始しなければならない

### 6. core/std 境界と no_std 互換
**目的:** ランタイム開発者として no_std コアを維持し、std 依存を拡張層に閉じ込めたい。

#### 受け入れ条件
- 6.1 core 機能がビルドされるとき、fraktor-streams は no_std のみでコンパイルできなければならない
- 6.2 std 機能を含む場合、fraktor-streams は std 依存を std モジュールに閉じ込めなければならない
- 6.3 core の公開 API が提供されている間、fraktor-streams は std 依存なしで利用可能であり続けなければならない

### 7. std 拡張の実行統合
**目的:** ランタイム利用者として std 環境での実行基盤と統合し、ストリームを実運用で動かしたい。

#### 受け入れ条件
- 7.1 std 拡張が有効なとき、fraktor-streams はホスト環境の実行基盤と統合してストリームを駆動しなければならない
- 7.2 std 拡張が有効なとき、fraktor-streams は Materializer を通じて実行基盤を利用できなければならない
- 7.3 std 拡張が無効なとき、fraktor-streams は std 依存を要求してはならない

### 8. examples による最小利用例
**目的:** ランタイム利用者として最小構成の使用例を参照し、設計意図を確認したい。

#### 受け入れ条件
- 8.1 std 拡張が有効なとき、fraktor-streams は examples で最小のストリーム構成サンプルを提供しなければならない
- 8.2 サンプルがビルドされるとき、fraktor-streams は core への std 依存を持ち込まずにコンパイルできなければならない
- 8.3 サンプルが実行されたとき、fraktor-streams は Materializer と Source/Flow/Sink の最小合成が動作することを示さなければならない
