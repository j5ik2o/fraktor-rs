# 実装計画

- [x] 1. ガーディアン状態管理の再構成
  - _対応要件: 1.1, 1.2, 1.3, 1.4_
  - _依存タスク: -_
- [x] 1.1 GuardiansState/Slot の実装刷新
  - GuardianSlotState を Unset/Set の判別共用体で表現する
  - GuardianSlot の set/clear を &mut self で実装し、PID と存活フラグの整合を担保する
  - GuardiansStateShared に new と SharedAccess 実装のみを持たせ、with_read/with_write で一元操作する
  - _対応要件: 1.1, 1.4_
  - _依存タスク: -_
  - _完了条件: GuardiansStateShared 経由で PID/flag 操作が行えることを確認する_
- [x] 1.2 cells 登録・解決の一貫化
  - register_cell で PID 登録時に actor_path_registry も同期させる現在の挙動を維持する
  - guardian_pid 解決を Cells 経由に統一し、直接保持を排除する
  - guardian_cell_via_cells で未登録時の None を定義し、呼び出し側ハンドリング前提を明記する
  - _対応要件: 1.1, 1.2, 1.3_
  - _依存タスク: 1.1_
  - _完了条件: Guardian PID と Cells 参照の単一経路が成立する_

- [x] 2. 終了・監視フローの PID 化
  - _対応要件: 2.1, 2.2, 2.3, 2.4_
  - _依存タスク: 1.2_
- [x] 2.1 ガーディアン停止時のフラグ更新
  - clear_guardian_pid が PID マッチで GuardianSlotState を Unset にし存活フラグを倒す
  - Termination future 完了条件を root flag 落下（または root 未設定＋system/user 停止）に合わせる
  - _対応要件: 2.1, 2.2, 2.3_
  - _依存タスク: 1.2_
  - _完了条件: 停止シナリオで termination future が期待通りに完了する_
- [x] 2.2 Terminated 即時応答パス
  - guardian_cell 解決が None の場合に Terminated を即時送信する処理を ActorSystem/ActorCell 経由で統一
  - watch/unwatch の遠隔・ローカル経路に対し同一ポリシーを適用する
  - _対応要件: 2.4_
  - _依存タスク: 2.1_
  - _完了条件: 停止済み PID への watch で Terminated が即返される_

- [x] 3. 起動タイプステートとガード
  - _対応要件: 3.1, 3.2, 3.3, 3.4_
  - _依存タスク: 1.2_
- [x] 3.1 Booting→Running 遷移の実装
  - BootingSystemStateGeneric にガーディアン PID 登録 API を用意し、3 つ揃ったら into_running で Running に遷移させる
  - 未登録 PID がある場合は BootstrapError::MissingGuardian を返す
  - _対応要件: 3.1, 3.2_
  - _依存タスク: 1.2_
  - _完了条件: 3 ガーディアン PID が揃わない限り Running に遷移しない_
- [x] 3.2 spawn/resolve ガードの適用
  - Booting 状態で spawn_child/spawn_child_watched/resolve_actor_ref を呼ぶと SystemNotBootstrapped を返すよう統一
  - Running 状態では guardian_pid が非 Option で取得できることを検証する
  - _対応要件: 3.2, 3.3, 3.4_
  - _依存タスク: 3.1_
  - _完了条件: Booting での誤用がエラーで防がれ、Running では非 Option 参照が可能_

- [x] 4. 既存 API・可観測性の互換維持
  - _対応要件: 4.1, 4.2, 4.3_
  - _依存タスク: 3.2_
- [x] 4.1 互換ラッパの内部更新
  - user_guardian_ref/system_guardian_ref 等の既存 API が PID 解決ラッパを通じて従来どおり動くことを確認する
  - ActorPath 生成・resolve で canonical/authority 振る舞いが変わらないように回帰確認する
  - _対応要件: 4.1, 4.3_
  - _依存タスク: 3.2_
  - _完了条件: 既存サンプル・テストがガーディアン参照変更による挙動差分を示さない_
- [x] 4.2 EventStream/ログへの影響確認
  - Terminated/Failure/Log イベントが PID ベースでも従来同等のペイロードで発火することを確認する
  - Remoting/拡張が PID 解決で問題なく動作するかを簡易シナリオで検証する
  - _対応要件: 4.2, 4.3_
  - _依存タスク: 4.1_
  - _完了条件: 主要イベントが旧実装と同じ内容で配信される_

- [x] 5. テスト強化と回帰確認
  - _対応要件: 1.* , 2.* , 3.* , 4.*_
  - _依存タスク: 4.2_
- [x] 5.1 ユニットテスト追加
  - GuardiansState/Slot の set/clear/pid/is_alive の正当性を検証する
  - Booting→Running 遷移の正常系・未設定エラー系をカバーする
  - guardian_cell_via_cells の None ケースを検証する
  - _対応要件: 1.*, 3.*
  - _依存タスク: 4.2_
  - _完了条件: 新設ユニットテストが green になる_
- [x] 5.2 統合テスト・回帰テスト
  - 3 ガーディアン生成から termination までのフローで termination future 完了を確認する
  - 停止済みガーディアンへの watch が即 Terminated を返すシナリオを検証する
  - ActorPath/EventStream/Remoting の主要シナリオが回帰しないことを確認する
  - _対応要件: 2.*, 4.*
  - _依存タスク: 5.1_
  - _完了条件: 統合テストが green で、観測イベントに差分がない_
