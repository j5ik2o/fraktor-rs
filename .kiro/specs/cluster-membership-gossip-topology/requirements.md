# 要件ドキュメント

## 導入
本仕様は、cluster モジュールの Membership/Gossip 基盤とトポロジ更新・メトリクス/イベント連動のアウトカムを定義する。

## 要件

### 要件1: Membership/Gossip基盤のライフサイクル
**目的:** クラスタ利用開発者として Membership/Gossip 基盤が起動・停止と状態公開を一貫して行うことで、手動の補助処理なしに運用したい。

#### 受け入れ条件
1. クラスタのメンバーモードが開始されたとき、クラスタランタイムは Membership/Gossip 基盤を稼働状態へ遷移させなければならない。
2. クラスタのシャットダウンが要求されたとき、クラスタランタイムは Membership/Gossip 基盤を停止し、関連リソースを解放しなければならない。
3. クラスタが未起動の間、クラスタランタイムは Membership/Gossip 入力を受け付けず、未起動として失敗を返し続けなければならない。
4. Gossip 機能を含む場合、クラスタランタイムはピア間で Membership 更新を交換しなければならない。
5. クラスタランタイムは常に現在の Membership スナップショットを参照可能な形で提供しなければならない。

### 要件2: MemberList 状態遷移と合意
**目的:** クラスタ運用者として、メンバーの状態遷移と合意が明確で一貫したルールに従うことで、運用判断を誤らないようにしたい。

#### 用語対応
- 本要件の **Join/Alive** は設計上の **Joining/Up** に対応する。

#### 受け入れ条件
1. メンバーの参加要求が受理されたとき、クラスタランタイムは当該メンバーを Join 状態として登録しなければならない。
2. メンバーの生存が確認されたとき、クラスタランタイムは当該メンバーを Alive 状態に遷移させなければならない。
3. 失敗検知が疑いを示したとき、クラスタランタイムは当該メンバーを Suspect 状態に遷移させなければならない。
4. 疑いが確定または除去が決定されたとき、クラスタランタイムは当該メンバーを Dead 状態に遷移させ、アクティブメンバーから除外しなければならない。
5. 不正な状態遷移が要求されたならば、クラスタランタイムは遷移を拒否し、理由を記録しなければならない。

### 要件3: 失敗検知と隔離ルール
**目的:** クラスタ運用者として、失敗検知と隔離が一貫したルールで適用されることで、障害時の判断と復旧を明確にしたい。

#### 受け入れ条件
1. 失敗検知が到達不能を通知したとき、クラスタランタイムは当該メンバーを隔離対象として扱い、隔離イベントを発火しなければならない。
2. メンバーが隔離されている間、クラスタランタイムは当該メンバーをアクティブメンバーから除外し続けなければならない。
3. 隔離中のメンバーが再参加を試みたならば、クラスタランタイムは参加を拒否し、隔離理由を通知しなければならない。
4. 隔離期間が満了したとき、クラスタランタイムは当該メンバーの再参加を許可しなければならない。
5. クラスタランタイムは常に隔離対象メンバーの一覧を参照可能な形で提供しなければならない。

### 要件4: トポロジ更新の生成と反映
**目的:** クラスタ利用開発者として、トポロジ更新が確実に生成・反映されることで、手動介入なしに最新のトポロジを利用したい。

#### 受け入れ条件
1. Membership に参加/離脱/死亡の変更が確定したとき、クラスタランタイムは TopologyUpdated を生成し、変更集合と現在のメンバー一覧を含めて通知しなければならない。
2. Membership に変更が発生していない間、クラスタランタイムは TopologyUpdated を生成し続けてはならない。
3. 同一の更新周期で複数の変更が観測されたとき、クラスタランタイムはそれらをまとめた単一の TopologyUpdated を生成しなければならない。
4. トポロジ更新の適用に失敗したならば、クラスタランタイムは失敗イベントを発火しなければならない。
5. TopologyUpdated が生成されたとき、クラスタランタイムは ClusterCore に反映しなければならない。

### 要件5: メトリクス/イベント連動
**目的:** クラスタ運用者として、メトリクスとイベントがトポロジ更新に同期して観測できることで、状態を正確に把握したい。

#### 受け入れ条件
1. TopologyUpdated が生成されたとき、クラスタランタイムはメンバー数などのメトリクスを更新しなければならない。
2. メンバー状態が変化したとき、クラスタランタイムは対応する ClusterEvent を EventStream に発火しなければならない。
3. メトリクス収集が無効である間、クラスタランタイムはメトリクス取得要求を失敗として返し続けなければならない。
4. クラスタランタイムは常にトポロジ更新および状態遷移イベントにタイムスタンプを付与しなければならない。
5. EventStream 購読者が登録されたとき、クラスタランタイムはトポロジ更新と状態遷移イベントを購読者へ配信しなければならない。
