# 要件ドキュメント

## 導入
本仕様は、永続化機能の内部アクター（Journal/Snapshot）をユーザAPIから隠蔽し、Pekko互換の利用体験に合わせることを目的とする。利用者は persistence_id の指定だけで永続アクターを構成でき、no_std 環境でも同一の概念で扱えることを求める。

## 要件

### 1. ユーザAPIの簡素化
**目的:** 開発者として永続アクターを内部ActorRefを意識せずに構成し、誤用や設定漏れを減らしたい。

#### 受け入れ条件
1. 永続アクターを構成するとき、永続化サブシステムは Journal/Snapshot の ActorRef をユーザに要求しないで構成できるようにしなければならない
2. 永続アクターが起動するとき、永続化サブシステムは内部通信経路を自動的に初期化しなければならない
3. persistence_id が指定されたとき、永続化サブシステムはその識別子を変更せずに利用しなければならない
4. 複数の永続アクターが生成されたとき、永続化サブシステムは各 actor の persistence_id が独立して扱われるようにしなければならない
5. 永続化サブシステムは常に Journal/Snapshot の ActorRef を公開APIに露出しないようにしなければならない

### 2. 永続化コンテキストの提供
**目的:** 開発者として継承に依存せず、合成により永続化機能を利用したい。

#### 受け入れ条件
1. 永続アクターが起動するとき、永続化サブシステムは永続化コンテキストを提供しなければならない
2. 永続アクターが永続化操作を行うとき、永続化サブシステムは永続化コンテキスト経由で操作できるようにしなければならない
3. 永続化コンテキストを公開APIに含む場合、永続化サブシステムは `.codex/skills/avoid-ambiguous-suffixes` の指針に従って名称を決定しなければならない

### 3. 拡張の登録と利用
**目的:** システム管理者として永続化拡張を一度登録し、複数の永続アクターで共通利用したい。

#### 受け入れ条件
1. ActorSystem に永続化拡張が登録されたとき、永続化サブシステムは永続アクターが拡張を参照できる状態を維持しなければならない
2. 永続アクターが起動するとき、永続化拡張が未登録ならば、永続化サブシステムは起動失敗を通知しなければならない
3. 永続化拡張が登録されている間、永続化サブシステムは同一 ActorSystem 内の複数永続アクターで拡張を共有して利用できるようにし続けなければならない
4. 永続化拡張が登録済みの間、永続化サブシステムは永続アクターの通常操作（persist、recovery、snapshot）が継続して実行できるようにしなければならない

### 4. 互換性と境界
**目的:** メンテナとして no_std と Pekko 互換の利用体験を維持し、環境差によるAPI分岐を最小化したい。

#### 受け入れ条件
1. no_std 環境で動作している間、永続化サブシステムは std 依存のAPIを要求せずに動作し続けなければならない
2. 永続アクターが永続化フロー（persist、recovery、snapshot）を実行するとき、永続化サブシステムは Journal/Snapshot の ActorRef をユーザが指定しなくても動作しなければならない
3. Pekko互換の利用体験を提供するために、永続化サブシステムは persistence_id だけで永続アクターを構成できる状態を維持し続けなければならない

### 5. 設計指針とサンプル整備
**目的:** メンテナとして設計指針の遵守を明確化し、利用者が前例に沿って導入できるようにしたい。

#### 受け入れ条件
1. 永続化コンテキストと関連APIの設計を行うとき、永続化サブシステムは `.codex/skills/core-std-boundary` の指針に従わなければならない
2. 永続化コンテキストと関連APIのエラー設計を行うとき、永続化サブシステムは `.codex/skills/rust-error-handling` の指針に従わなければならない
3. 永続化コンテキストと関連APIの設計を行うとき、永続化サブシステムは `.codex/skills/rust-simplify` の指針に従わなければならない
4. 永続化コンテキストと共有設計を行うとき、永続化サブシステムは `.codex/skills/shared-wrapper-design` の指針に従わなければならない
5. 永続化APIの提供形態を変更する場合、永続化サブシステムは既存の examples の構成と記法に合わせた新しい examples を提供しなければならない
