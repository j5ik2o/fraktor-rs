# Implementation Plan

## Task Format Template

- [x] 1. 永続化拡張の登録と生成基盤を整える
- [x] 1.1 ブート時に拡張を登録できるようにする
  - Journal/Snapshot の供給元を保持し、起動時に拡張が登録されるようにする
  - 起動失敗時のエラー伝播方針を明確にする
  - _Requirements: 1.2, 3.1, 3.2, 4.1, 5.2_

- [x] 1.2 拡張が内部アクターを生成し、ActorRef を隠蔽して共有できるようにする
  - system guardian 経由で内部アクターを生成する
  - 複数の永続アクターから同じ拡張を安全に共有できる
  - ActorRef を公開 API に露出しない
  - _Requirements: 1.4, 1.5, 3.3, 3.4, 4.2, 5.4_

- [x] 1.3 永続化コンテキストを拡張から取得できるようにする
  - 起動時にコンテキストが提供されるようにする
  - 永続化操作がコンテキスト経由で行えるようにする
  - 命名規約を満たす
  - _Requirements: 1.1, 2.1, 2.2, 2.3, 4.2, 5.3_

- [x] 2. 永続化状態とAPIの合成を整える
- [x] 2.1 永続化状態の初期化と単一ソースの制約を整備する
  - persistence_id は Actor 側の値のみを使用し、外部から差し替え不可にする
  - 永続化状態が Actor ごとに独立して維持される
  - _Requirements: 1.3, 1.4, 4.3_

- [x] 2.2 永続化APIを context/state 合成に寄せる
  - ActorRef を要求しない操作経路に統一する
  - 既存の永続化フローが同等に動作する
  - _Requirements: 1.1, 1.5, 2.2, 3.4, 4.2_

- [x] 2.3 no_std 境界と単純さを保った設計に整える
  - core 層に std 依存が混入しない
  - 不要な抽象化を増やさない
  - _Requirements: 4.1, 5.1, 5.3_

- [x] 3. 自動初期化と公開入口を実装する
- [x] 3.1 Adapter による自動初期化と復旧開始を保証する
  - 起動時フックで拡張取得・context/state 結合・recovery 開始が必ず行われる
  - 拡張未登録時は起動失敗として扱う
  - _Requirements: 1.2, 3.2, 4.3, 5.2_

- [x] 3.2 永続アクター生成の公開入口を一本化する
  - Adapter を内側で強制適用する生成経路を用意する
  - Adapter を public API に露出しない
  - _Requirements: 1.1, 1.2, 1.5, 4.2_

- [x] 3.3 旧来の基底構造を廃止して新構成へ移行する
  - 旧 API 依存を解消して新構成で一貫させる
  - _Requirements: 3.4, 5.3_

- [x] 4. テストと例の整備で統合する
- [x] 4.1 単体テストで拡張登録・自動初期化・persistence_id の不変性を検証する
  - 拡張登録と取得の動作を検証する
  - 拡張未登録時の起動失敗を検証する
  - persistence_id が外部から変更されないことを検証する
  - _Requirements: 1.2, 1.3, 3.1, 3.2, 4.3, 5.2_

- [x] 4.2 統合テストで ActorRef 非公開の永続化フローを検証する
  - ActorRef を渡さずに永続化フローが成立することを確認する
  - 複数 actor で拡張を共有しても独立性が保たれることを確認する
  - _Requirements: 1.1, 1.4, 1.5, 3.3, 3.4, 4.2_

- [x] 4.3 既存 examples を新 API に合わせて更新する
  - 永続アクター生成が新しい入口経由で行えるようにする
  - ActorRef を要求しない利用例にする
  - _Requirements: 5.5, 1.1, 4.2_
