# 実装計画

- [ ] 1. クラスタ拡張の土台を整える
  - _対応要件: 1.1,1.2,1.3,1.5,2.3,4.5,5.2_
  - _依存タスク: -_

- [x] 1.1 依存関係と構成状態を初期化する
  - クラスタコアに config・ClusterProvider・BlockList 取得口・EventStream・RuntimeToolbox ベースの同期原語を注入できるようにする。
  - メンバー/クライアント両モードで再利用できる起動パラメータを保持し、再初期化なしで呼び出せるようにする。
  - metrics 有効/無効を判定するフラグを構成から読み取り、以降の処理が分岐できる準備を整える。
  - _対応要件: 1.1,1.2,1.3,4.5,5.2_
  - _依存タスク: -_
  - _完了条件: コア生成時に必要な依存が欠けず、モード変更なしで再利用できることを確認する_

- [x] 1.2 起動・停止イベントのロギング導線を用意する
  - EventStream にクラスタ拡張専用イベントを追加し、起動/停止/失敗/トポロジ変化をモードとアドレス付きで流せるようにする。
  - 起動失敗時の理由やシャットダウン要求を含めたログ出力フォーマットを決め、以降の処理で統一する。
  - 起動/停止の結果を metrics や依存タスクがフックできるよう、通知フックを用意する。
  - _対応要件: 1.5,1.3,1.4_
  - _依存タスク: 1.1_
  - _完了条件: 成功/失敗/停止の各シナリオで EventStream にモードとアドレスを含めて通知できる_

- [ ] 2. Kind 登録と Identity 基盤を整える
  - _対応要件: 2.1,2.2,2.3,2.4,2.5,5.4_
  - _依存タスク: 1.1_

- [x] 2.1 Kind 登録と TopicKind 自動登録を実装する
  - Kind 設定を読み込み、必要な Kind を組み立てて登録する。
  - TopicActorKind が未登録なら自動追加し、以降の PubSub 起動が失敗しないようにする。
  - Kind 登録結果を後続の IdentityLookup 初期化へ渡せる形で保持する。
  - _対応要件: 2.1_
  - _依存タスク: 1.1_
  - _完了条件: メンバー起動時に Kind 一覧が揃い、TopicActorKind が確実に登録されている_

- [x] 2.2 Kind 参照の検証と構成の安定性を確保する
  - GetClusterKind で未登録 Kind が要求された際に無効を記録し、空の結果を返す処理を追加する。
  - Kind 構成が変化していない場合は再ビルドを避け、初期化時の構成を保持し続ける。
  - Kind 参照ロジックが他コンポーネントと整合するよう、キャッシュの整合性を確認する。
  - _対応要件: 2.2,2.4_
  - _依存タスク: 2.1_
  - _完了条件: 未登録 Kind 問い合わせで空応答となり、構成不変時に再ビルドが走らないことを確認する_

- [x] 2.3 IdentityLookup セットアップと仮想アクター集計を行う
  - member/client モードに応じて Kind 一覧を渡しつつ IdentityLookup を初期化するフローを用意する。
  - VirtualActorCount を登録済み Kind から集計し、問い合わせ時に即座に返せるようにする。
  - 初期化と集計がメトリクス更新とも整合するよう、値の保持場所を統一する。
  - _対応要件: 2.3,2.5,5.4_
  - _依存タスク: 2.1_
  - _完了条件: モード別セットアップ完了後に仮想アクター数が取得でき、後続のメトリクス更新と一致する_

- [ ] 3. 起動・停止ライフサイクルを実装する
  - _対応要件: 1.1,1.2,1.3,1.4,1.5,3.3_
  - _依存タスク: 1.1,2.1,2.3_

- [x] 3.1 メンバー起動シーケンスを確立する
  - Remote と ClusterProvider の初期化、KindRegistry と IdentityLookup 設定を順に実行し、失敗したステップ以降を中断する。
  - いずれかが失敗した場合に起動済みサブシステムを逆順で停止し、理由を含めてエラーを返すロールバックを組み込む。
  - 起動成功時に MemberList のトポロジコンセンサスを初期化し、アドレスとモードを含めた起動イベントを発火する。
  - _対応要件: 1.1,1.3,3.3,1.5_
  - _依存タスク: 1.1,2.1,2.3_
  - _完了条件: StartMember が成功/失敗の両ケースで期待通りの戻り値とイベントを出す_

- [x] 3.2 クライアント起動シーケンスを確立する
  - クライアントモードで Remote 起動と ClusterProvider.start_client 相当の処理を実行し、IdentityLookup をクライアント設定でセットアップする。
  - 失敗時は理由付きでエラーを返し、起動済みサブシステムを停止するロールバックを実施する。
  - 成功/失敗のどちらでもモードとアドレスを含むイベントを EventStream に発火する。
  - _対応要件: 1.2,1.3,2.3,1.5_
  - _依存タスク: 1.1,2.3_
  - _完了条件: StartClient が成功/失敗時に適切なロールバックとイベント通知を行う_

- [x] 3.3 グレースフルシャットダウンを実装する
  - シャットダウン要求時に PubSub→Gossip→IdentityLookup→MemberList の順で停止し、Remote を最後に停止する。
  - graceful=false でも停止処理を実行し、完了時/失敗時のイベントを EventStream へ発火する。
  - 停止後にメンバー数と仮想アクター数のメトリクスをリセットし、シャットダウン理由をロギングする。
  - _対応要件: 1.4,1.5,4.4,5.3_
  - _依存タスク: 3.1,4.1,4.2_
  - _完了条件: 停止順序が要求通りで、成功/失敗イベントとメトリクスリセットが検証される_

- [ ] 4. Gossip・PubSub・トポロジ連動を整備する
  - _対応要件: 3.1,3.2,3.4,3.5,4.1,4.2,4.3,4.4,4.5,5.3_
  - _依存タスク: 3.1,3.2_

- [x] 4.1 Gossip の起動と伝播を実装する
  - メンバー起動直後に Gossip を開始し、起動失敗や開始エラー時は致命的エラーとして起動処理を中断する。
  - Gossip が稼働中は最新トポロジを配布し続け、停止要求でクリーンに終了できる経路を用意する。
  - 起動/停止/失敗の各ケースでイベントを発火し、後続のトポロジ処理やメトリクス更新が参照できるようにする。
  - _対応要件: 3.4,4.1,4.3,4.4_
  - _依存タスク: 3.1_
  - _完了条件: Gossip 開始/停止/失敗が期待通りに遷移し、致命的エラーで起動を中断できる_

- [x] 4.2 PubSub の起動と Topic 受付を実装する
  - PubSub を起動し、TopicActorKind が登録済みであることを前提に購読受付を有効化する。
  - 起動時にエラーがあれば理由を含めて起動失敗を返し、Gossip/Cluster 起動を中止する。
  - PubSub 稼働中に Topic ごとの購読イベントを受け付け、停止時には順序立てて終了する。
  - _対応要件: 4.2,4.3,2.1_
  - _依存タスク: 2.1,3.1_
  - _完了条件: PubSub 起動・停止が TopicKind 前提で動き、失敗時は起動を中断できる_

- [ ] 4.3 BlockList 取得経路を組み込む
  - Remote 由来の BlockListProvider からブロック対象一覧を取得し、クラスタコアに保持する。
  - トポロジイベント生成時に blocked フィールドへ反映し、EventStream 経由で通知できるようにする。
  - BlockList 取得エラー時はクラスタ起動を失敗扱いとし、理由を返す。
  - _対応要件: 4.5,1.1_
  - _依存タスク: 1.1,3.1_
  - _完了条件: BlockList を含むトポロジイベントが生成・配信される_

- [ ] 4.4 トポロジ更新ハンドリングを実装する
  - 受信した ClusterTopology のハッシュを前回と比較し、変化がない場合はイベント発火を抑制する。
  - 離脱ノードを PID キャッシュから削除し、MemberList を更新して joined/left 差分を計算する。
  - metrics 有効時にメンバー数メトリクスを更新し、blocked を含むトポロジイベントを EventStream に発火する。
  - _対応要件: 3.1,3.2,3.5,5.3,4.4_
  - _依存タスク: 4.1,4.3_
  - _完了条件: トポロジ変更時のみイベント・メトリクスが更新され、離脱キャッシュが確実に無効化される_

- [ ] 5. 観測性とメトリクスを整備する
  - _対応要件: 5.1,5.2,5.3,5.4,5.5,1.5_
  - _依存タスク: 1.2,4.4_

- [ ] 5.1 メトリクス初期化と無効時の応答を実装する
  - metrics 設定を読み取り、有効時のみ ClusterMetrics を初期化し、無効時は未収集状態を明示的に保持する。
  - metrics 無効な状態で値取得が要求された場合に未収集メッセージを返す経路を用意する。
  - metrics オブジェクトへのアクセスをクラスタ内部で一元化し、更新漏れを防ぐ。
  - _対応要件: 5.1,5.2,5.5_
  - _依存タスク: 1.1_
  - _完了条件: metrics 有効/無効の双方で期待通りの応答が確認できる_

- [ ] 5.2 メンバー数と仮想アクター数の更新を実装する
  - 起動完了・トポロジ更新時にメンバー数と仮想アクター数を集計し、ClusterMetrics に反映する。
  - VirtualActorCount を KindRegistry から集計し、問い合わせ時に最新値を返せるようにする。
  - metrics 更新と EventStream 発火のタイミングを揃え、監視側で整合した値を観測できるようにする。
  - _対応要件: 5.3,5.4,2.5_
  - _依存タスク: 2.3,4.4_
  - _完了条件: トポロジ変更後にメンバー数と仮想アクター数が一致して更新される_

- [ ] 5.3 クラスタイベントの観測ログを整備する
  - 起動/停止/Topology/失敗の各イベントを EventStreamEvent::Extension("cluster") として発火し、ロガーへアドレスとモードを記録する。
  - metrics 状態や BlockList を含むトポロジ詳細をログ出力し、監視指標と整合するようにする。
  - 重大エラー時に再試行や停止判断をできるよう、理由を含めたイベントを必ず発火する。
  - _対応要件: 1.5,3.4,4.3_
  - _依存タスク: 1.2,4.4_
  - _完了条件: 主要イベントが EventStream に載り、ログでアドレス・モード・理由が確認できる_

- [ ] 6. テストを整備する
  - _対応要件: 1.1,1.2,1.3,1.4,1.5,2.1,2.2,2.3,2.4,2.5,3.1,3.2,3.3,3.4,3.5,4.1,4.2,4.3,4.4,4.5,5.1,5.2,5.3,5.4,5.5_
  - _依存タスク: 3.3,4.4,5.2_

- [ ] 6.1 コアユニットテストで主要フローを網羅する
  - StartMember/StartClient の成功・失敗パスとロールバック、EventStream へのイベント内容を検証する。
  - Kind 登録・未登録アクセス・構成保持、metrics 無効時の未収集応答など状態ごとの振る舞いを確認する。
  - トポロジハッシュ抑制、PID キャッシュ無効化、BlockList 連携を単体で検証する。
  - _対応要件: 1.1,1.2,1.3,1.5,2.1,2.2,2.4,3.1,3.2,3.5,5.5_
  - _依存タスク: 3.1,3.2,2.2,5.1_
  - _完了条件: ユニットテストが成功し、主要フローの成功/失敗パスが緑になる_

- [ ] 6.2 統合テストでクラスタ連動を確認する
  - 複数ノード相当のシナリオで start_member 後に Gossip/PubSub/Topology が連動することを確認する。
  - トポロジ変更時に PID キャッシュ削除・BlockList 反映・メンバー数/仮想アクター数メトリクス更新が揃うことを検証する。
  - シャットダウン要求で順序通りに停止し、イベントとメトリクスがリセットされることを確認する。
  - _対応要件: 1.4,2.3,2.5,3.1,3.3,3.4,4.1,4.2,4.3,4.4,5.1,5.3,5.4_
  - _依存タスク: 6.1,4.4,5.2_
  - _完了条件: マルチノード相当の統合テストが成功し、イベント・メトリクス・トポロジの整合性が取れている_

- [ ] 7. クラスタ利用例のサンプルを追加する
  - `modules/cluster/examples/` 配下に起動・停止・Kind 登録を行う最小サンプルを追加する（std feature 前提）。
  - StartMember/StartClient 双方の起動と EventStream クラスタイベントの観測ログを含める。
  - README 相当の簡易実行手順をサンプルファイル冒頭コメント（日本語）で示す。
  - _対応要件: 1.1,1.2,1.5,2.1,2.3_
  - _依存タスク: 3.3,5.2_
  - _完了条件: サンプルがビルド可能で、最小手順でクラスタイベントが出力されること_
